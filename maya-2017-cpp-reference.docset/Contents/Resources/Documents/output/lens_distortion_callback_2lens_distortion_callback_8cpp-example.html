<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
<head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="MAYAUL" name="product"><meta content="2017" name="release"><meta content="Developer" name="book"><meta content="2016-06-16" name="created"><meta content="GUID-02DEF634-1E7B-48C6-8ACD-2C934CA97887" name="topicid"><meta content="concept" name="topic-type">
<title>lensDistortionCallback/lensDistortionCallback.cpp</title>
<meta content="C++" name="topic-subtype"/></meta></meta></meta></meta></meta></meta></meta></head>
<body height="100%"><div class="body_content" id="body-content"><link href="cpp_ref/navtree.css" rel="stylesheet" type="text/css"><link href="cpp_ref/doxygen.css" rel="stylesheet" type="text/css"><link href="cpp_ref/tabs.css" rel="stylesheet" type="text/css"><link href="style/adsk.cpm.css" rel="stylesheet" type="text/css"><script language="javascript">var index = 'index.html';</script><script>$(document).ready(function() { yepnope.injectJs("./scripts/ac_common.js"); });</script><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('lens_distortion_callback_2lens_distortion_callback_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type="text/javascript">$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->
<div class="Dark" id="MicrosoftTranslatorWidget" style="float:right;z-index:100;color:white;background-color:#bbbbbb;height:58px;overflow:hidden"></div>
<div>
<div class="head">
<h1>lensDistortionCallback/lensDistortionCallback.cpp</h1>
</div>
<div id="top"><!-- Generated by Doxygen 1.8.10 -->
<div class="tabs" id="navrow1">
<ul class="tablist">
<li><a href="./index.html"><span>MainÂ Page</span></a></li>
<li><a href="./pages.html"><span>Topics</span></a></li>
<li><a href="./modules.html"><span>Modules</span></a></li>
<li><a href="./namespaces.html"><span>Namespaces</span></a></li>
<li><a href="./annotated.html"><span>Classes</span></a></li>
<li><a href="./examples.html"><span>Examples</span></a></li>
</ul>
</div>
</div><!-- top -->
<div class="ui-resizable side-nav-resizable" id="side-nav">
<div id="nav-tree">
<div id="nav-tree-contents">
<div class="sync" id="nav-sync"></div>
</div>
</div>
<div class="ui-resizable-handle" id="splitbar" style="-moz-user-select:none;">
</div>
</div>
<div id="doc-content">
<div class="header">
<div class="headertitle">
<div class="title">lensDistortionCallback/lensDistortionCallback.cpp</div> </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">// DESCRIPTION:</span></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"><span class="comment">// Produces the command "lensDistortionCallback".</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// This plug-in demonstrates how to enable multiple draw-passes with the M3dView</span></div>
<div class="line"><span class="comment">// class and add the pre and post rendering callbacks to each pass by the MUiMessage class.</span></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"><span class="comment">// A distortion effect is added to the model view for previewing lens distortion</span></div>
<div class="line"><span class="comment">// that uses decomposed radial and tangential distortion coefficient.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Some essential attributes must first be added to the camera node. The following is</span></div>
<div class="line"><span class="comment">// a sample MEL script that adds essential attributes to a perspective camera and sets</span></div>
<div class="line"><span class="comment">// the example values to attributes that affect the lens distortion result.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  select perspShape;</span></div>
<div class="line"><span class="comment">//  //  Add extra attributes</span></div>
<div class="line"><span class="comment">//  addAttr -at bool -ln "previewLensDistortion" -sn "pld" -dv 1;</span></div>
<div class="line"><span class="comment">//  addAttr -at long -ln "previewResolutionX" -sn "prx" -dv 40 -min 1 ;</span></div>
<div class="line"><span class="comment">//  addAttr -at long -ln "previewResolutionY" -sn "pry" -dv 30 -min 1 ;</span></div>
<div class="line"><span class="comment">//  addAttr -at long -ln "renderResolutionX" -sn "rrx" -dv 1920 -min 1 ;</span></div>
<div class="line"><span class="comment">//  addAttr -at long -ln "renderResolutionY" -sn "rry" -dv 1080 -min 1 ;</span></div>
<div class="line"><span class="comment">//  addAttr -at double -ln "principalPointX" -sn "ppx" -dv 963.893;</span></div>
<div class="line"><span class="comment">//  addAttr -at double -ln "principalPointY" -sn "ppy" -dv 541.666;</span></div>
<div class="line"><span class="comment">//  addAttr -at double -ln "radialDistortionCoef1" -sn "rdc1" -dv 0.00677651;</span></div>
<div class="line"><span class="comment">//  addAttr -at double -ln "radialDistortionCoef2" -sn "rdc2" -dv -0.000162221;</span></div>
<div class="line"><span class="comment">//  addAttr -at double -ln "tangentialDistortionCoef1" -sn "tdc1" -dv -0.0005091;</span></div>
<div class="line"><span class="comment">//  addAttr -at double -ln "tangentialDistortionCoef2" -sn "tdc2" -dv -5.55102e-005;</span></div>
<div class="line"><span class="comment">//  addAttr -at double -ln "scaleFactor" -sn "sf" -dv 1.0;</span></div>
<div class="line"><span class="comment">//  addAttr -at bool -ln "drawWireframe" -sn "sdw" -dv 1;</span></div>
<div class="line"><span class="comment">//  // Setup camera focal/film attributes.</span></div>
<div class="line"><span class="comment">//  setAttr .focalLength 4.674975;</span></div>
<div class="line"><span class="comment">//  setAttr .horizontalFilmAperture 0.3774;</span></div>
<div class="line"><span class="comment">//  setAttr .verticalFilmAperture 0.2122;</span></div>
<div class="line"><span class="comment">//  setAttr .horizontalFilmOffset -0.00132157;</span></div>
<div class="line"><span class="comment">//  setAttr .verticalFilmOffset 0.000327253;</span></div>
<div class="line"><span class="comment">//  setAttr .filmFit 2;</span></div>
<div class="line"><span class="comment">//  // Setup camera display attributes.(Additional)</span></div>
<div class="line"><span class="comment">//  setAttr .displayResolution 1;</span></div>
<div class="line"><span class="comment">//  setAttr .overscan 1.5;</span></div>
<div class="line"><span class="comment">//  // Setup rendering resolution.</span></div>
<div class="line"><span class="comment">//  setAttr defaultResolution.width 1920;</span></div>
<div class="line"><span class="comment">//  setAttr defaultResolution.height 1080;</span></div>
<div class="line"><span class="comment">//  setAttr defaultResolution.deviceAspectRatio 1.777778;</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// The following is a sample MEL command for using this plug-in once it is loaded:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  lensDistortionCallback `getPanel -withFocus`;</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Note that the screen does not refresh right after the plug-in executes. You must refresh the screen with a tumbling camera.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="preprocessor">#include "lensDistortionCallback.h"</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGlobal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MString.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDagPath.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MMatrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPlug.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPlugArray.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MImage.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MIOStream.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnCamera.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnDependencyNode.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MColor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnPlugin.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MHardwareRenderer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGLdefinitions.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define kFloatEpsilon       1.0e-10</span></div>
<div class="line"><span class="preprocessor">#define kRemoveFlag         "-r"</span></div>
<div class="line"><span class="preprocessor">#define kRemoveFlagLong     "-remove"</span></div>
<div class="line"><span class="preprocessor">#define kExistFlag          "-ex"</span></div>
<div class="line"><span class="preprocessor">#define kExistFlagLong      "-exists"</span></div>
<div class="line"><span class="preprocessor">#define kListFlag           "-l"</span></div>
<div class="line"><span class="preprocessor">#define kListFlagLong       "-list"</span></div>
<div class="line"></div>
<div class="line">lensDistortionCompute* lensDistortionCompute::currentLensDistortionCompute[MAX_MODEL_PANEL];</div>
<div class="line"></div>
<div class="line"><span class="comment">// ------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// lensDistortionCallback implementation</span></div>
<div class="line"><span class="comment">// ------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line">lensDistortionCallback::lensDistortionCallback()</div>
<div class="line">:</div>
<div class="line">    mRemoveOperation( false )</div>
<div class="line">,   mExistOperation( false )</div>
<div class="line">,   mListOperation( false )</div>
<div class="line">{</div>
<div class="line">    mPanelName = <a name="_a0"></a><a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">""</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">lensDistortionCallback::~lensDistortionCallback()</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span>* lensDistortionCallback::creator()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *) (<span class="keyword">new</span> lensDistortionCallback);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a name="_a1"></a><a class="code" href="./class_m_syntax.html">MSyntax</a> lensDistortionCallback::newSyntax()</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_syntax.html">MSyntax</a> syntax;</div>
<div class="line">    syntax.<a name="a2"></a><a class="code" href="./class_m_syntax.html#aeaeaac3794bb4de8004afb1ac1829488">addFlag</a>( kRemoveFlag,    kRemoveFlagLong,    <a name="a3"></a><a class="code" href="./class_m_syntax.html#ae6f2057f0d0419845a48c1eb6813f2adafab53ea4a643325262b9c140af093279">MSyntax::kString</a>);</div>
<div class="line">    syntax.<a class="code" href="./class_m_syntax.html#aeaeaac3794bb4de8004afb1ac1829488">addFlag</a>( kExistFlag,     kExistFlagLong,     <a class="code" href="./class_m_syntax.html#ae6f2057f0d0419845a48c1eb6813f2adafab53ea4a643325262b9c140af093279">MSyntax::kString</a>);</div>
<div class="line">    syntax.<a class="code" href="./class_m_syntax.html#aeaeaac3794bb4de8004afb1ac1829488">addFlag</a>( kListFlag,      kListFlagLong );</div>
<div class="line">    syntax.<a name="a4"></a><a class="code" href="./class_m_syntax.html#a1d306e0ce61954dd7cbdcd0e74a905a6">addArg</a>(<a class="code" href="./class_m_syntax.html#ae6f2057f0d0419845a48c1eb6813f2adafab53ea4a643325262b9c140af093279">MSyntax::kString</a>);</div>
<div class="line"> <span class="keywordflow">return</span> syntax;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a name="_a5"></a><a class="code" href="./class_m_status.html">MStatus</a> lensDistortionCallback::parseArgs(<span class="keyword">const</span> <a name="_a6"></a><a class="code" href="./class_m_arg_list.html">MArgList</a>&amp; args)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a>         status;</div>
<div class="line"> <a name="_a7"></a><a class="code" href="./class_m_arg_database.html">MArgDatabase</a>    argDatabase( syntax(), args, &amp;status);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( status != <a name="a8"></a><a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> ) <span class="keywordflow">return</span> status;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( args.<a name="a9"></a><a class="code" href="./class_m_arg_list.html#a99dd6a54b909ede1d11702fe58977e2a">length</a>() == 1 )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> thisArg = args.<a name="a10"></a><a class="code" href="./class_m_arg_list.html#ad24ff3826e4df513b55e1a0ecb0a665b">asString</a>( 0, &amp;status );</div>
<div class="line"> <span class="keywordflow">if</span> ( thisArg == kListFlag || thisArg == kListFlagLong )</div>
<div class="line">        {</div>
<div class="line">            mListOperation = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Adding callback to given panel </span></div>
<div class="line">            mRemoveOperation = <span class="keyword">false</span>;</div>
<div class="line">            mExistOperation  = <span class="keyword">false</span>;</div>
<div class="line">            mPanelName = argDatabase.commandArgumentString( 0, &amp;status );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( args.<a class="code" href="./class_m_arg_list.html#a99dd6a54b909ede1d11702fe58977e2a">length</a>() == 2 )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> thisArg = args.<a class="code" href="./class_m_arg_list.html#ad24ff3826e4df513b55e1a0ecb0a665b">asString</a>( 0, &amp;status );</div>
<div class="line"> <span class="keywordflow">if</span> ( thisArg == kRemoveFlag || thisArg == kRemoveFlagLong )</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Removing callback from given panel </span></div>
<div class="line">            mRemoveOperation = <span class="keyword">true</span>;</div>
<div class="line">            mPanelName = argDatabase.flagArgumentString( kRemoveFlag, 0, &amp;status );</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( thisArg == kExistFlag || thisArg == kExistFlagLong )</div>
<div class="line">        {</div>
<div class="line">            mExistOperation = <span class="keyword">true</span>;</div>
<div class="line">            mPanelName = argDatabase.flagArgumentString( kExistFlag, 0, &amp;status );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> <a name="a11"></a><a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MStatus::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> lensDistortionCallback::doIt(<span class="keyword">const</span> <a class="code" href="./class_m_arg_list.html">MArgList</a>&amp; args)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Parse argument</span></div>
<div class="line">    status = parseArgs(args);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (status != <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>){    </div>
<div class="line">        displayError( <span class="stringliteral">"Argument should have a panel name and proper option"</span> );</div>
<div class="line"> <span class="keywordflow">return</span> status; </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Process list operation</span></div>
<div class="line"> <span class="keywordflow">if</span> ( mListOperation )</div>
<div class="line">    {</div>
<div class="line"> <a name="_a12"></a><a class="code" href="./class_m_string_array.html">MStringArray</a> panelNames;</div>
<div class="line">        status =  lensDistortionCompute::listCallback( panelNames );</div>
<div class="line">        setResult ( panelNames );</div>
<div class="line"> <span class="keywordflow">return</span> status;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Check if the given model panel name is valid or invalid.</span></div>
<div class="line"> <a name="_a13"></a><a class="code" href="./class_m3d_view.html">M3dView</a> view;</div>
<div class="line">    status = <a name="a14"></a><a class="code" href="./class_m3d_view.html#a6f8dcac6993b14738fc6259cfd50a3b8">M3dView::getM3dViewFromModelPanel</a> ( mPanelName,  view );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (status != <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>){    </div>
<div class="line">        displayError( <span class="stringliteral">"Specified model panel is not valid!"</span> );</div>
<div class="line"> <span class="keywordflow">return</span> status; </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Process add/remove/query existence operation</span></div>
<div class="line"> <span class="keywordflow">if</span> ( mExistOperation )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Query existence of callback</span></div>
<div class="line"> <span class="keywordflow">if</span> ( lensDistortionCompute::panelHasCallback( mPanelName ) )</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Callback is found</span></div>
<div class="line">            setResult( <span class="keyword">true</span> );</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Callback is not found</span></div>
<div class="line">            setResult( <span class="keyword">false</span> );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mRemoveOperation )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Remove an instance of lensDistortionCompute</span></div>
<div class="line">        status = lensDistortionCompute::removeCallbackFromPanel( mPanelName );</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> </div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Add an instance of lensDistortionCompute</span></div>
<div class="line">        status = lensDistortionCompute::addCallbackToPanel( mPanelName );</div>
<div class="line"> <span class="keywordflow">if</span> ( status == <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> )</div>
<div class="line">        {</div>
<div class="line">            setResult( mPanelName );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// lensDistortionCompute implementation</span></div>
<div class="line"><span class="comment">// ------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line">lensDistortionCompute::lensDistortionCompute(<span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a> &amp;panelName)</div>
<div class="line">:</div>
<div class="line">    mTextureIndex( 0 )</div>
<div class="line">,   mTextureWidth( 0 )</div>
<div class="line">,   mTextureHeight( 0 )</div>
<div class="line">,   mMultipleDrawPassCount( 1 )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Set panel name and operator for post rendering</span></div>
<div class="line">    mPanelName = panelName;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Add the callbacks</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    mDeleteId</div>
<div class="line">        = <a name="a15"></a><a class="code" href="./class_m_ui_message.html#af55a37b0bf511201f58c91b5f64ebea7">MUiMessage::add3dViewDestroyMsgCallback</a>(panelName,</div>
<div class="line">                                           &amp;lensDistortionCompute::deleteCB,</div>
<div class="line">                                           (<span class="keywordtype">void</span> *) <span class="keyword">this</span>, &amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (mDeleteId == 0)</div>
<div class="line"> <a name="a16"></a><a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Could not attach view deletion callback to panel "</span>) + panelName);</div>
<div class="line"></div>
<div class="line">    mPreRenderId</div>
<div class="line">        = <a name="a17"></a><a class="code" href="./class_m_ui_message.html#a896e7f0af2318e5a7145e189cb235912">MUiMessage::add3dViewPreRenderMsgCallback</a>(panelName,</div>
<div class="line">                                          &amp;lensDistortionCompute::preRenderCB,</div>
<div class="line">                                          (<span class="keywordtype">void</span> *) <span class="keyword">this</span>, &amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (mPreRenderId == 0)</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Could not attach view prerender callback to panel "</span>) + panelName);</div>
<div class="line"></div>
<div class="line">    mPostRenderId</div>
<div class="line">        = <a name="a18"></a><a class="code" href="./class_m_ui_message.html#af33879a7a29a0853f35ede9de091beb1">MUiMessage::add3dViewPostRenderMsgCallback</a>(panelName,</div>
<div class="line">                                           &amp;lensDistortionCompute::postRenderCB,</div>
<div class="line">                                           (<span class="keywordtype">void</span> *) <span class="keyword">this</span>, &amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (mPostRenderId == 0)</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Could not attach view postrender callback to panel "</span>) + panelName);</div>
<div class="line"></div>
<div class="line">    mPreMultipleDrawPassId  </div>
<div class="line">        = <a name="a19"></a><a class="code" href="./class_m_ui_message.html#a92d313b3f24215cac37a1a746fbe8dd1">MUiMessage::add3dViewPreMultipleDrawPassMsgCallback</a>(panelName,    </div>
<div class="line">                                        &amp;lensDistortionCompute::preMultipleDrawPassCB,  (<span class="keywordtype">void</span> *) <span class="keyword">this</span>, &amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (mPreMultipleDrawPassId == 0)    </div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Could not attach view pre-multiple draw pass callback to panel "</span>) + panelName);</div>
<div class="line"></div>
<div class="line">    mPostMultipleDrawPassId </div>
<div class="line">        = <a name="a20"></a><a class="code" href="./class_m_ui_message.html#ad2f007e72a3ede2e25d4b956629a6fa7">MUiMessage::add3dViewPostMultipleDrawPassMsgCallback</a>(panelName, </div>
<div class="line">                                        &amp;lensDistortionCompute::postMultipleDrawPassCB, (<span class="keywordtype">void</span> *) <span class="keyword">this</span>, &amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (mPostMultipleDrawPassId == 0)   </div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Could not attach view post-multiple draw pass callback to panel "</span>) + panelName);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">lensDistortionCompute::~lensDistortionCompute()</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Clear all callback that associated with this model panel.</span></div>
<div class="line">    clearCallbacks();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Reset any global pointer pointing to this compute</span></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;MAX_MODEL_PANEL; i++)</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> (currentLensDistortionCompute[i] &amp;&amp; </div>
<div class="line">            (currentLensDistortionCompute[i])-&gt;getPanelName() == mPanelName)</div>
<div class="line">        {</div>
<div class="line">            currentLensDistortionCompute[i] = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Delete GL texture if it is created.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( mTextureIndex )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Make rendering context current.</span></div>
<div class="line"> <a name="_a21"></a><a class="code" href="./class_m_hardware_renderer.html">MHardwareRenderer</a> *pRenderer = MHardwareRenderer::theRenderer();</div>
<div class="line"> <span class="keywordflow">if</span> ( pRenderer )</div>
<div class="line">        {</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; backEnd = pRenderer-&gt;<a name="a22"></a><a class="code" href="./class_m_hardware_renderer.html#afd786038730d9c301a6b3a489d22d816">backEndString</a>();</div>
<div class="line">            pRenderer-&gt;<a name="a23"></a><a class="code" href="./class_m_hardware_renderer.html#afa4f9cf4ae2429c6999089ebaaba38e1">makeResourceContextCurrent</a>( backEnd );</div>
<div class="line">            glDeleteTextures( 1, &amp;mTextureIndex );</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <span class="stringliteral">"Rendering context is not current! Memory leak will occurs."</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Add an instance of lensDistortionCompute to given panal </span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> lensDistortionCompute::addCallbackToPanel( <a class="code" href="./class_m_string.html">MString</a>&amp; pPanelName )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line"> <span class="comment">// Check if the panel is already created.</span></div>
<div class="line"> <span class="comment">// Check if callback list has an empty entry.</span></div>
<div class="line"> <span class="keywordtype">bool</span>    found       = <span class="keyword">false</span>;</div>
<div class="line"> <span class="keywordtype">int</span>     emptyIndex  = -1;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; MAX_MODEL_PANEL; i++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( currentLensDistortionCompute[i] )</div>
<div class="line">        { </div>
<div class="line"> <span class="keywordflow">if</span> ( currentLensDistortionCompute[i]-&gt;getPanelName() == pPanelName )</div>
<div class="line">            {</div>
<div class="line">                found = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            emptyIndex = i;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( found )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// The panel already has a callback</span></div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"Specified model panel already has a callback!"</span>);</div>
<div class="line">        status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( emptyIndex == -1 ) </div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Callback list doesn't have empty entry.</span></div>
<div class="line"> <span class="comment">// Any panel will not be added.</span></div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"Maximum number of callbacks are registered. Delete another callback"</span>);</div>
<div class="line">        status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// The panel doesn't has a callback and callback list has empty entry.</span></div>
<div class="line"> <span class="comment">// Add an instance of lensDistortionCompute.</span></div>
<div class="line">        currentLensDistortionCompute[emptyIndex] = <span class="keyword">new</span> lensDistortionCompute( pPanelName );</div>
<div class="line">        status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Remove an instance of lensDistortionCompute from panel</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> </div>
<div class="line">lensDistortionCompute::removeCallbackFromPanel( <a class="code" href="./class_m_string.html">MString</a>&amp; pPanelName )</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Check if the callback which associated with given panel is already created.</span></div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; MAX_MODEL_PANEL; i++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( currentLensDistortionCompute[i] &amp;&amp; </div>
<div class="line">             currentLensDistortionCompute[i]-&gt;getPanelName() == pPanelName )</div>
<div class="line">        {</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Remove an instance of lensDistortionCompute</span></div>
<div class="line"> <span class="keyword">delete</span> currentLensDistortionCompute[i];</div>
<div class="line">            currentLensDistortionCompute[i] = NULL;</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// The panel doesn't have a callback.</span></div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"Specified model panel doesn't have a callback!"</span>);</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Query existence of instance of lensDistortionCompute for panel</span></div>
<div class="line"><span class="keywordtype">bool</span> </div>
<div class="line">lensDistortionCompute::panelHasCallback( <a class="code" href="./class_m_string.html">MString</a>&amp; pPanelName )</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Does this panel have the callback?</span></div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; MAX_MODEL_PANEL; i++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( currentLensDistortionCompute[i] &amp;&amp; </div>
<div class="line">            (currentLensDistortionCompute[i])-&gt;getPanelName() == pPanelName )</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Panel is found.</span></div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Panel is not found</span></div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// List names of the panels which have a callback attached</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> </div>
<div class="line">lensDistortionCompute::listCallback( <a class="code" href="./class_m_string_array.html">MStringArray</a>&amp; pPanelNames )</div>
<div class="line">{</div>
<div class="line">    pPanelNames.<a name="a24"></a><a class="code" href="./class_m_string_array.html#ad5522f028dde0080b753279426415a4a">clear</a>();</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; MAX_MODEL_PANEL; i++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( currentLensDistortionCompute[i])</div>
<div class="line">        {</div>
<div class="line">            pPanelNames.<a name="a25"></a><a class="code" href="./class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>( (currentLensDistortionCompute[i])-&gt;getPanelName() );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> lensDistortionCompute::clearCallbacks()</div>
<div class="line">{   </div>
<div class="line"> <span class="keywordflow">if</span> (mDeleteId)</div>
<div class="line"> <a name="a26"></a><a class="code" href="./class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MMessage::removeCallback</a>(mDeleteId);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (mPreRenderId)</div>
<div class="line"> <a class="code" href="./class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MMessage::removeCallback</a>(mPreRenderId);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (mPostRenderId)</div>
<div class="line"> <a class="code" href="./class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MMessage::removeCallback</a>(mPostRenderId);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (mPreMultipleDrawPassId)</div>
<div class="line"> <a class="code" href="./class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MMessage::removeCallback</a>( mPreMultipleDrawPassId );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (mPostMultipleDrawPassId)</div>
<div class="line"> <a class="code" href="./class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MMessage::removeCallback</a>( mPostMultipleDrawPassId );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Called when associated model panel deleted</span></div>
<div class="line"><span class="keywordtype">void</span> lensDistortionCompute::deleteCB(<span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; panelName, <span class="keywordtype">void</span> * data)</div>
<div class="line">{</div>
<div class="line">    lensDistortionCompute *thisCompute = (lensDistortionCompute *) data;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Check if this panel name is renamed.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( panelName != thisCompute-&gt;mPanelName )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"lensDistortionCallback does not support renaming of panels. Callback removed."</span>);</div>
<div class="line">    }</div>
<div class="line"> <span class="comment">// Delete callback.</span></div>
<div class="line"> <span class="keyword">delete</span> thisCompute;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> lensDistortionCompute::preRenderCB(<span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; panelName, <span class="keywordtype">void</span> * data)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Get a pointer to current callback</span></div>
<div class="line">    lensDistortionCompute *thisCompute = (lensDistortionCompute *) data;</div>
<div class="line"> <span class="keywordflow">if</span> (!thisCompute)</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status = <a class="code" href="./class_m3d_view.html#a6f8dcac6993b14738fc6259cfd50a3b8">M3dView::getM3dViewFromModelPanel</a>(panelName, thisCompute-&gt;mCurrentView );</div>
<div class="line"> <span class="keywordflow">if</span> (status != <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>) <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Store current object display status and multiple draw pass count.</span></div>
<div class="line">    thisCompute-&gt;mObjectDisplayState = thisCompute-&gt;mCurrentView.objectDisplay();</div>
<div class="line">    thisCompute-&gt;mMultipleDrawPassCount = thisCompute-&gt;mCurrentView.multipleDrawPassCount();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Enable multi pass draw;</span></div>
<div class="line">    thisCompute-&gt;mCurrentView.setMultipleDrawEnable( <span class="keyword">true</span> );</div>
<div class="line">    thisCompute-&gt;mCurrentView.setMultipleDrawPassCount( 2 );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> lensDistortionCompute::postRenderCB(<span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; panelName, <span class="keywordtype">void</span> * data)</div>
<div class="line">{   </div>
<div class="line">    lensDistortionCompute *thisCompute = (lensDistortionCompute *) data;</div>
<div class="line"> <span class="keywordflow">if</span> (!thisCompute)</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Draw </span></div>
<div class="line">    thisCompute-&gt;draw();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Disable multi pass draw.</span></div>
<div class="line">    thisCompute-&gt;mCurrentView.setMultipleDrawEnable( <span class="keyword">false</span> );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Restore object display state and multiple draw pass count.</span></div>
<div class="line">    thisCompute-&gt;mCurrentView.setObjectDisplay( thisCompute-&gt;mObjectDisplayState );</div>
<div class="line">    thisCompute-&gt;mCurrentView.setMultipleDrawPassCount( thisCompute-&gt;mMultipleDrawPassCount );</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">lensDistortionCompute::preMultipleDrawPassCB( <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; pPanelName, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> passIndex, <span class="keywordtype">void</span> * data)</div>
<div class="line">{</div>
<div class="line">    lensDistortionCompute *thisCompute = (lensDistortionCompute *) data;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Update view</span></div>
<div class="line">    thisCompute-&gt;mCurrentView.beginGL();</div>
<div class="line"> <a name="_a27"></a><a class="code" href="./class_m_color.html">MColor</a> currentBackgroundColor = thisCompute-&gt;mCurrentView.backgroundColor();</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span>( passIndex == 0 <span class="comment">/*Drawing other than image plane pass*/</span>)</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">//  Clear background with alpha = 0.0 for blending.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="comment">//  Since a specific blending function is used to blend the lens distorted models with image plane, </span></div>
<div class="line"> <span class="comment">//  transparent objects are not blend with properly. </span></div>
<div class="line">        glClearColor( currentBackgroundColor.<a name="a28"></a><a class="code" href="./class_m_color.html#a4788d82c901b9367dd5c0daff8a7616b">r</a>, currentBackgroundColor.<a name="a29"></a><a class="code" href="./class_m_color.html#a8cf17d727651616de6f2b79ef32170cd">g</a>, currentBackgroundColor.<a name="a30"></a><a class="code" href="./class_m_color.html#a83fc1af92e29717b4513d121b0c72c7d">b</a>, 0.0 ); </div>
<div class="line">        glClear( GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Hide image plane.</span></div>
<div class="line">        thisCompute-&gt;mCurrentView.setObjectDisplay( thisCompute-&gt;mObjectDisplayState &amp; ~<a name="a31"></a><a class="code" href="./class_m3d_view.html#a169efed3046f92a7f5159d4e67207c31a30b228c407444d40373bb769d7b856e1">M3dView::kDisplayImagePlane</a>);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="comment">/* Drawing image plane pass */</span></div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Restore clear color.</span></div>
<div class="line">        glClearColor( currentBackgroundColor.<a class="code" href="./class_m_color.html#a4788d82c901b9367dd5c0daff8a7616b">r</a>, currentBackgroundColor.<a class="code" href="./class_m_color.html#a8cf17d727651616de6f2b79ef32170cd">g</a>, currentBackgroundColor.<a class="code" href="./class_m_color.html#a83fc1af92e29717b4513d121b0c72c7d">b</a>,  currentBackgroundColor.<a name="a32"></a><a class="code" href="./class_m_color.html#a4aec1a5be9d9a4a394a2e49e9744286e">a</a> );</div>
<div class="line">        glClear( GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Hide other than image plane.</span></div>
<div class="line">        thisCompute-&gt;mCurrentView.setObjectDisplay( <a name="a33"></a><a class="code" href="./class_m3d_view.html#a169efed3046f92a7f5159d4e67207c31a4b3d0e34ff5537f07f17cec6d600c983">M3dView::kDisplayCameras</a> | <a class="code" href="./class_m3d_view.html#a169efed3046f92a7f5159d4e67207c31a30b228c407444d40373bb769d7b856e1">M3dView::kDisplayImagePlane</a> );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    thisCompute-&gt;mCurrentView.endGL();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">lensDistortionCompute::postMultipleDrawPassCB( <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; pPanelName, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> passIndex, <span class="keywordtype">void</span> * data)</div>
<div class="line">{</div>
<div class="line">    lensDistortionCompute *thisCompute = (lensDistortionCompute *) data;</div>
<div class="line"></div>
<div class="line">    thisCompute-&gt;mCurrentView.beginGL();</div>
<div class="line"> <span class="keywordflow">if</span> ( passIndex == 0 <span class="comment">/*Drawing other than image plane pass*/</span>)</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Store rendering result to mPrimaryBuffer for post-render callback.</span></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status = thisCompute-&gt;mCurrentView.readColorBuffer( thisCompute-&gt;mPrimaryBuffer, <span class="keyword">true</span> );</div>
<div class="line"> <span class="keywordflow">if</span> ( status != <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> )</div>
<div class="line">        {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"Storing rendering result to buffer failed because of memory shortage. Please delete unused callbacks or decrease panel size."</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="comment">/* Drawing image plane pass */</span></div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line">    thisCompute-&gt;mCurrentView.endGL();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">lensDistortionCompute::textureUpdate()</div>
<div class="line">{   </div>
<div class="line"> </div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, height;</div>
<div class="line">    mPrimaryBuffer.getSize( width, height );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Rebuild gl texture if model panel size is changed.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( mTextureWidth != width || mTextureHeight != height )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( mTextureIndex )</div>
<div class="line">        {</div>
<div class="line">            glDeleteTextures( 1, &amp;mTextureIndex );</div>
<div class="line">        }</div>
<div class="line">        mTextureIndex = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!mTextureIndex ){</div>
<div class="line"> </div>
<div class="line">        glGenTextures( 1, &amp;mTextureIndex );</div>
<div class="line">        glBindTexture( GL_TEXTURE_2D, mTextureIndex );</div>
<div class="line"></div>
<div class="line">        glTexParameteri ( GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, MGL_CLAMP_TO_EDGE );    <span class="comment">// Refreshed texture should not be wrapped.</span></div>
<div class="line">        glTexParameteri ( GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, MGL_CLAMP_TO_EDGE );    <span class="comment">// Refreshed texture should not be wrapped.</span></div>
<div class="line">        glTexParameteri ( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR );</div>
<div class="line">        glTexParameteri ( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR );</div>
<div class="line"></div>
<div class="line">        glTexImage2D( </div>
<div class="line">            GL_TEXTURE_2D   <span class="comment">// Target</span></div>
<div class="line">            , 0             <span class="comment">// Level</span></div>
<div class="line">            , GL_RGBA       <span class="comment">// Inernal Format</span></div>
<div class="line">            , width         <span class="comment">// Width</span></div>
<div class="line">            , height        <span class="comment">// Height</span></div>
<div class="line">            , 0             <span class="comment">// Border</span></div>
<div class="line">            , GL_RGBA       <span class="comment">// Format</span></div>
<div class="line">            , GL_UNSIGNED_BYTE <span class="comment">// Type</span></div>
<div class="line">            , mPrimaryBuffer.pixels() <span class="comment">// Data</span></div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Save texture size to check model panel size change.</span></div>
<div class="line">        mTextureWidth  = width;</div>
<div class="line">        mTextureHeight = height;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Copy color buffer to generated texture object.</span></div>
<div class="line">        glBindTexture( GL_TEXTURE_2D, mTextureIndex );</div>
<div class="line"></div>
<div class="line">        glTexSubImage2D(</div>
<div class="line">            GL_TEXTURE_2D   <span class="comment">// Target</span></div>
<div class="line">            , 0             <span class="comment">// Level</span></div>
<div class="line">            , 0         <span class="comment">// X offset</span></div>
<div class="line">            , 0         <span class="comment">// Y offset</span></div>
<div class="line">            , width         <span class="comment">// Width</span></div>
<div class="line">            , height    <span class="comment">// Height</span></div>
<div class="line">            , GL_RGBA       <span class="comment">// Format</span></div>
<div class="line">            , GL_UNSIGNED_BYTE <span class="comment">// Type</span></div>
<div class="line">            , mPrimaryBuffer.pixels() <span class="comment">// Data</span></div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">lensDistortionCompute::draw()</div>
<div class="line">{</div>
<div class="line">    textureUpdate();</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!mTextureIndex)</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Texture is not initialized correctly. retunr.</span></div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <span class="stringliteral">"Texture is not initialized correctly"</span>);</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get lens distortion related param</span></div>
<div class="line"> <a name="_a34"></a><a class="code" href="./class_m_dag_path.html">MDagPath</a> camera;</div>
<div class="line">    mCurrentView.getCamera( camera );</div>
<div class="line"> <a name="_a35"></a><a class="code" href="./class_m_object.html">MObject</a> cameraNode = camera.<a name="a36"></a><a class="code" href="./class_m_dag_path.html#ad1aa507eb8e63e89e8d46a0abc18aa8c">node</a>();</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">double</span> width = mCurrentView.portWidth();</div>
<div class="line"> <span class="keywordtype">double</span> height = mCurrentView.portHeight();</div>
<div class="line"> <span class="keywordtype">int</span>    previewResolutionX       = getIntValueFromCameraAttr( cameraNode,<span class="stringliteral">"previewResolutionX"</span> );</div>
<div class="line"> <span class="keywordtype">int</span>    previewResolutionY       = getIntValueFromCameraAttr( cameraNode,<span class="stringliteral">"previewResolutionY"</span> );</div>
<div class="line"> <span class="keywordtype">double</span> renderResolutionX        = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"renderResolutionX"</span> );</div>
<div class="line"> <span class="keywordtype">double</span> renderResolutionY        = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"renderResolutionY"</span> );</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">double</span> principalPointX          = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"principalPointX"</span>);</div>
<div class="line"> <span class="keywordtype">double</span> principalPointY          = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"principalPointY"</span> );</div>
<div class="line"> <span class="keywordtype">double</span> kc1                      = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"radialDistortionCoef1"</span> );</div>
<div class="line"> <span class="keywordtype">double</span> kc2                      = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"radialDistortionCoef2"</span> );</div>
<div class="line"> <span class="keywordtype">double</span> kc3                      = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"tangentialDistortionCoef1"</span> );</div>
<div class="line"> <span class="keywordtype">double</span> kc4                      = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"tangentialDistortionCoef2"</span> );</div>
<div class="line"> <span class="keywordtype">double</span> horizontalFilmAperture   = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"horizontalFilmAperture"</span> )  * 25.4;</div>
<div class="line"> <span class="keywordtype">double</span> verticalFilmAperture     = getDoubleValueFromCameraAttr( cameraNode,<span class="stringliteral">"verticalFilmAperture"</span> ) * 25.4;</div>
<div class="line"> <span class="keywordtype">bool</span>   drawWireframe            = getBoolValueFromCameraAttr( cameraNode, <span class="stringliteral">"drawWireframe"</span> );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Begin OpenGL </span></div>
<div class="line">    mCurrentView.beginGL();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Push current matrix and load inverse projection matrix</span></div>
<div class="line"> <a name="_a37"></a><a class="code" href="./class_m_matrix.html">MMatrix</a> projMatrix;</div>
<div class="line">    mCurrentView.projectionMatrix(projMatrix);</div>
<div class="line">    glPushMatrix();</div>
<div class="line">    glLoadMatrixd( (<span class="keyword">const</span> GLdouble *)projMatrix.<a name="a38"></a><a class="code" href="./class_m_matrix.html#a8ca5ebc404566e2c4a16d4754772e082">inverse</a>().<a name="a39"></a><a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a> );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Store all OpenGL state</span></div>
<div class="line">    glPushAttrib( GL_ALL_ATTRIB_BITS );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Draw lens distortion plane with blending</span></div>
<div class="line">    glEnable( GL_BLEND );</div>
<div class="line">    glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );</div>
<div class="line">    glEnable( GL_TEXTURE_2D );</div>
<div class="line">    glTexEnvf( GL_TEXTURE_ENV,  GL_TEXTURE_ENV_MODE, GL_REPLACE );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Enable polygon offset fill when wireframe is on.</span></div>
<div class="line"> <span class="keywordflow">if</span> ( drawWireframe )</div>
<div class="line">    {</div>
<div class="line">        glEnable( GL_POLYGON_OFFSET_FILL );</div>
<div class="line">        glPolygonOffset( 0.95f, 1.0f ); </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    drawLensDistortionPlane( </div>
<div class="line">        GL_QUADS</div>
<div class="line">        ,renderResolutionX, renderResolutionY</div>
<div class="line">        ,previewResolutionX, previewResolutionY </div>
<div class="line">        , width, height</div>
<div class="line">        , principalPointX, principalPointY</div>
<div class="line">        , kc1, kc2, kc3, kc4</div>
<div class="line">        , horizontalFilmAperture, verticalFilmAperture</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">    glDisable( GL_TEXTURE_2D );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Draw lens distortion plane with wireframe</span></div>
<div class="line"> <span class="keywordflow">if</span> ( drawWireframe )</div>
<div class="line">    {</div>
<div class="line">        glDisable( GL_POLYGON_OFFSET_FILL );</div>
<div class="line">        glColor3f( 0.0f, 0.0f, 0.0f );</div>
<div class="line"></div>
<div class="line">        drawLensDistortionPlane( </div>
<div class="line">            GL_LINE_LOOP</div>
<div class="line">            , renderResolutionX, renderResolutionY</div>
<div class="line">            , previewResolutionX, previewResolutionY</div>
<div class="line">            , width, height</div>
<div class="line">            , principalPointX, principalPointY</div>
<div class="line">            , kc1, kc2, kc3, kc4</div>
<div class="line">            , horizontalFilmAperture, verticalFilmAperture</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Restore OpenGL state</span></div>
<div class="line">    glPopAttrib();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Restore matrix</span></div>
<div class="line">    glPopMatrix();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// End OpenGL </span></div>
<div class="line">    mCurrentView.endGL();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">lensDistortionCompute::drawLensDistortionPlane(</div>
<div class="line">    GLenum drawMethod</div>
<div class="line">    , <span class="keywordtype">double</span> renderResolutionX</div>
<div class="line">    , <span class="keywordtype">double</span> renderResolutionY</div>
<div class="line">    , <span class="keywordtype">int</span>    previewResolutionX</div>
<div class="line">    , <span class="keywordtype">int</span>    previewResolutionY</div>
<div class="line">    , <span class="keywordtype">double</span> width</div>
<div class="line">    , <span class="keywordtype">double</span> height</div>
<div class="line">    , <span class="keywordtype">double</span> principalPointX</div>
<div class="line">    , <span class="keywordtype">double</span> principalPointY</div>
<div class="line">    , <span class="keywordtype">double</span> kc1, <span class="keywordtype">double</span> kc2, <span class="keywordtype">double</span> kc3, <span class="keywordtype">double</span> kc4</div>
<div class="line">    , <span class="keywordtype">double</span> horizontalFilmAperture</div>
<div class="line">    , <span class="keywordtype">double</span> verticalFilmAperture)</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span> ( previewResolutionX &lt; 1 || previewResolutionY &lt; 1 )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"The previewResolutionX and previewResolutionY has to be more than 1."</span>);</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordtype">double</span> xSub                     = 1.0 / (double)previewResolutionX;</div>
<div class="line"> <span class="keywordtype">double</span> ySub                     = 1.0 / (double)previewResolutionY;</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; previewResolutionX ; i ++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; previewResolutionY; j++ )</div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Draw rectangle with applying lens distortion</span></div>
<div class="line">            glBegin( drawMethod );</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">double</span> x, y;</div>
<div class="line"> <span class="keywordtype">double</span> u, v;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// P0 </span></div>
<div class="line">            x = u =  i * xSub;</div>
<div class="line">            y = v =  j * ySub;</div>
<div class="line"></div>
<div class="line">            applyLensDistortion( </div>
<div class="line">                x, y </div>
<div class="line">                ,renderResolutionX, renderResolutionY</div>
<div class="line">                , width, height</div>
<div class="line">                , principalPointX, principalPointY</div>
<div class="line">                , kc1, kc2, kc3, kc4</div>
<div class="line">                , horizontalFilmAperture, verticalFilmAperture </div>
<div class="line">                );</div>
<div class="line"></div>
<div class="line">            glTexCoord2d(  u, v );</div>
<div class="line">            glVertex2d(  x, y );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// P1 </span></div>
<div class="line">            x = u =  i * xSub;</div>
<div class="line">            y = v =  (j + 1) * ySub;</div>
<div class="line"></div>
<div class="line">            applyLensDistortion( </div>
<div class="line">                x, y </div>
<div class="line">                ,renderResolutionX, renderResolutionY</div>
<div class="line">                , width, height</div>
<div class="line">                , principalPointX, principalPointY</div>
<div class="line">                , kc1, kc2, kc3, kc4</div>
<div class="line">                , horizontalFilmAperture, verticalFilmAperture </div>
<div class="line">                );      </div>
<div class="line"></div>
<div class="line">            glTexCoord2d(  u, v );</div>
<div class="line">            glVertex2d(  x, y );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// P2</span></div>
<div class="line">            x = u =  (i + 1) * xSub;</div>
<div class="line">            y = v =  (j + 1) * ySub;</div>
<div class="line"></div>
<div class="line">            applyLensDistortion( </div>
<div class="line">                x, y </div>
<div class="line">                ,renderResolutionX, renderResolutionY</div>
<div class="line">                , width, height</div>
<div class="line">                , principalPointX, principalPointY</div>
<div class="line">                , kc1, kc2, kc3, kc4</div>
<div class="line">                , horizontalFilmAperture, verticalFilmAperture </div>
<div class="line">                );</div>
<div class="line"></div>
<div class="line">            glTexCoord2d(  u, v );</div>
<div class="line">            glVertex2d(  x, y );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// P3</span></div>
<div class="line">            x = u =  (i + 1) * xSub;</div>
<div class="line">            y = v =  j * ySub;</div>
<div class="line"></div>
<div class="line">            applyLensDistortion( </div>
<div class="line">                x, y </div>
<div class="line">                ,renderResolutionX, renderResolutionY</div>
<div class="line">                , width, height</div>
<div class="line">                , principalPointX, principalPointY</div>
<div class="line">                , kc1, kc2, kc3, kc4</div>
<div class="line">                , horizontalFilmAperture, verticalFilmAperture </div>
<div class="line">                );</div>
<div class="line"> </div>
<div class="line">            glTexCoord2d(  u, v );</div>
<div class="line">            glVertex2d(  x, y );</div>
<div class="line"> </div>
<div class="line">            glEnd();</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Apply lens distortion to given x/y positions which are normalized in screen space</span></div>
<div class="line"><span class="comment">// with most commonly used lens distortion technique which uses decomposed radial</span></div>
<div class="line"><span class="comment">// and tangential distortion coefficient.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Since this using lens model uses radial and tangential distortion coeffs which </span></div>
<div class="line"><span class="comment">// are calibrated in millimeter unit space, positions must be converted from normalized </span></div>
<div class="line"><span class="comment">// screen space to physical millimeter space to get correct result.</span></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"><span class="comment">// See "Manual of Photogrammetry, fourth ed., C.C. Slama, ed., </span></div>
<div class="line"><span class="comment">// Falls Church, Va.: Am. Soc. Photogramettry, 1980" for more details on using lens model.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  ------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//  </span></div>
<div class="line"><span class="comment">//  [Apply lens distortion]</span></div>
<div class="line"><span class="comment">//  Xn, Yn  :   Current position                    ( in normalized screen space )</span></div>
<div class="line"><span class="comment">//  Xd, Yd  :   Lens distortion applied posittion   ( in normalized screen space )</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  X0, Y0  :   Center of image                     ( in pixel space )</span></div>
<div class="line"><span class="comment">//  rW, rH  :   Resolution width/ height of image   ( in pixel space )</span></div>
<div class="line"><span class="comment">//              Used for offsetting center of image </span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  fH, fV  :   Horizontal/vertical film aperture   ( in millimeter )</span></div>
<div class="line"><span class="comment">//              Used for converting from normalized screen space to millimeter space</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  kc1     :   Radial Distortion coeff 1           ( in millimeter * 10^-2 )</span></div>
<div class="line"><span class="comment">//  kc2     :   Radial Distortion coeff 2           ( in millimeter * 10^-4 )</span></div>
<div class="line"><span class="comment">//  kc3     :   Tangential Distortion coeff 1       ( in millimeter * 10^-1 )</span></div>
<div class="line"><span class="comment">//  kc4     :   Tangential Distortion coeff 2       ( in millimeter * 10^-1 )</span></div>
<div class="line"><span class="comment">//              These coeffs should be calibrated in millimeter unit space</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  ------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  // Offset center </span></div>
<div class="line"><span class="comment">//  Xn' = Xn - X0/rW    Yn' = Yn - Y0/rH</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  // Convert from normlized screen space to physical space ( millimeter )</span></div>
<div class="line"><span class="comment">//  // Xn'', Yn'' : Current position in physical space ( millimeter )</span></div>
<div class="line"><span class="comment">//  Xn'' = Xn' * fH     Yn'' = Yn' * fW</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  // Apply lens distortion model</span></div>
<div class="line"><span class="comment">//  RR = Xn''^2 + Yn''^2 </span></div>
<div class="line"><span class="comment">//  Q = 1 / (4*kc1*RR + 6*kc2*rn^4 + 8*kc3*Yn'' + 8*kc4*Xn'' + 1 )</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Xd''= Xn'' - Q * ( Xn'' *( kc1 * RR + kc2 * RR^2) + 2*kc3 * Xn'' * Yn'' + kc4 * ( RR + 2*Xn''^2) )</span></div>
<div class="line"><span class="comment">//  Yd''= Yn'' - Q * ( Yn'' *( kc1 * RR + kc2 * RR^2) + kc3 * ( RR+ 2*Yn''^2) + 2 * kc4 * Xn'' * Yn'' ) </span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  // Convert from physical space ( millimeter ) to normalized screen space.</span></div>
<div class="line"><span class="comment">//  Xd' = Xd'' / fH     Yd' = Yd'' / hW</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  // Restore center offset</span></div>
<div class="line"><span class="comment">//  Xd =  Xd' + X0/rW   Yd = Yd' + Y0/rH</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">lensDistortionCompute::applyLensDistortion( </div>
<div class="line"> <span class="keywordtype">double</span>&amp; Xd</div>
<div class="line">        , <span class="keywordtype">double</span>&amp; Yd</div>
<div class="line">        , <span class="keywordtype">double</span> renderResolutionX</div>
<div class="line">        , <span class="keywordtype">double</span> renderResolutionY</div>
<div class="line">        , <span class="keywordtype">double</span> width</div>
<div class="line">        , <span class="keywordtype">double</span> height</div>
<div class="line">        , <span class="keywordtype">double</span> principalPointX</div>
<div class="line">        , <span class="keywordtype">double</span> principalPointY</div>
<div class="line">        , <span class="keywordtype">double</span> kc1, <span class="keywordtype">double</span> kc2, <span class="keywordtype">double</span> kc3, <span class="keywordtype">double</span> kc4</div>
<div class="line">        , <span class="keywordtype">double</span> horizontalFilmAperture</div>
<div class="line">        , <span class="keywordtype">double</span> verticalFilmAperture</div>
<div class="line">        )</div>
<div class="line">{</div>
<div class="line"> <span class="keywordtype">double</span> Xn = Xd ;</div>
<div class="line"> <span class="keywordtype">double</span> Yn = ( 1.0 - Yd ) ;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Determine center offset by given principal point and normalize position.</span></div>
<div class="line"> <span class="comment">// Principal point is calibrated "center of lens".</span></div>
<div class="line"> <span class="keywordtype">double</span> centerOffsetX = principalPointX / renderResolutionX;</div>
<div class="line"> <span class="keywordtype">double</span> centerOffsetY = principalPointY / renderResolutionY;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Convert physical space (millimeter).</span></div>
<div class="line"> <span class="comment">// Assume image and film are fitted perfectly. </span></div>
<div class="line">    Xn = (Xn - centerOffsetX ) * (horizontalFilmAperture );</div>
<div class="line">    Yn = (Yn - centerOffsetY ) * (verticalFilmAperture) ;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Apply generic pinhole camera model </span></div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( fabs( kc1 ) &lt; kFloatEpsilon &amp;&amp;</div>
<div class="line">        fabs( kc2 )  &lt; kFloatEpsilon &amp;&amp;</div>
<div class="line">        fabs( kc3 )  &lt; kFloatEpsilon &amp;&amp;</div>
<div class="line">        fabs( kc4 )  &lt; kFloatEpsilon </div>
<div class="line">    )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Normalize it </span></div>
<div class="line">        Xd = Xd * 2.0 - 1.0;</div>
<div class="line">        Yd  = Yd * 2.0 - 1.0;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Apply lens distortion formula</span></div>
<div class="line"> <span class="keywordtype">double</span> RR = (Xn * Xn) + (Yn * Yn);</div>
<div class="line"> <span class="keywordtype">double</span> Q = 1 / ( (4 * kc1 * RR) + (6 * kc2 * RR*RR) + (8 * kc3 * Yn) + (8 * kc4 * Xn) + 1 );</div>
<div class="line"></div>
<div class="line">    Xd = Xn - Q * ( Xn * ( kc1 * RR + kc2 * RR * RR )   + 2 * kc3 * Xn * Yn +   kc4 * ( RR + 2 * Xn * Xn) );</div>
<div class="line">    Yd = Yn - Q * ( Yn * ( kc1 * RR + kc2 * RR * RR )   +kc3 * ( RR + 2 * Yn * Yn) +2 * kc4 * Xn * Yn );</div>
<div class="line"></div>
<div class="line"> <span class="comment">//  Convert to normalized space</span></div>
<div class="line">    Xd = Xd / horizontalFilmAperture + centerOffsetX;</div>
<div class="line">    Yd = Yd / verticalFilmAperture + centerOffsetY ;</div>
<div class="line">    Yd = 1.0 - Yd;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Normalize it </span></div>
<div class="line">    Xd  = Xd * 2.0 - 1.0;</div>
<div class="line">    Yd  = Yd * 2.0 - 1.0;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Get an int attribute value from associated node;</span></div>
<div class="line"><span class="keywordtype">int</span> </div>
<div class="line">lensDistortionCompute::getIntValueFromCameraAttr( <a class="code" href="./class_m_object.html">MObject</a>&amp; node, <a class="code" href="./class_m_string.html">MString</a> attrName )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"> <a name="_a40"></a><a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> nodeFn ( node );</div>
<div class="line"></div>
<div class="line"> <a name="_a41"></a><a class="code" href="./class_m_plug.html">MPlug</a> plug = nodeFn.findPlug( attrName, status );</div>
<div class="line"> <span class="keywordflow">if</span> (status == <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> plug.<a name="a42"></a><a class="code" href="./class_m_plug.html#a22f1eaa836ac421f53d0a745e8eb2cd8">asInt</a>();</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <span class="stringliteral">"Please add :"</span> + attrName + <span class="stringliteral">" attribute to "</span> + nodeFn.name() );</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Get a double attribute value from given node;</span></div>
<div class="line"><span class="keywordtype">double</span> </div>
<div class="line">lensDistortionCompute::getDoubleValueFromCameraAttr(  <a class="code" href="./class_m_object.html">MObject</a>&amp; node, <a class="code" href="./class_m_string.html">MString</a> attrName )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"> <a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> nodeFn ( node );</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> plug = nodeFn.findPlug( attrName, status );</div>
<div class="line"> <span class="keywordflow">if</span> (status == <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> plug.<a name="a43"></a><a class="code" href="./class_m_plug.html#acb5276d3f8a82a3b48f4fcddb277a275">asDouble</a>();</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <span class="stringliteral">"Please add :"</span> + attrName + <span class="stringliteral">" attribute to "</span> + nodeFn.name() );</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> 0.0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Get a bool attribute value from given node;</span></div>
<div class="line"><span class="keywordtype">bool</span> </div>
<div class="line">lensDistortionCompute::getBoolValueFromCameraAttr(  <a class="code" href="./class_m_object.html">MObject</a>&amp; node, <a class="code" href="./class_m_string.html">MString</a> attrName )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"> <a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> nodeFn ( node );</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> plug = nodeFn.findPlug( attrName, status );</div>
<div class="line"> <span class="keywordflow">if</span> (status == <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> plug.<a name="a44"></a><a class="code" href="./class_m_plug.html#aea1ddab8d4272d03146b3dad29be3af0">asBool</a>();</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <span class="stringliteral">"Please add :"</span> + attrName + <span class="stringliteral">" attribute to "</span> + nodeFn.name() );</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> initializePlugin( <a class="code" href="./class_m_object.html">MObject</a> obj )</div>
<div class="line">{ </div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a>   status;</div>
<div class="line"> <a name="_a45"></a><a class="code" href="./class_m_fn_plugin.html">MFnPlugin</a> plugin( obj, <span class="stringliteral">"Autodesk"</span>, <span class="stringliteral">"1.0"</span>, <span class="stringliteral">"Any"</span>);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Register the command so we can actually do some work</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;MAX_MODEL_PANEL; i++)</div>
<div class="line">    {</div>
<div class="line">        lensDistortionCompute::currentLensDistortionCompute[i] = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    status = plugin.registerCommand(<span class="stringliteral">"lensDistortionCallback"</span>,</div>
<div class="line">                                    lensDistortionCallback::creator,</div>
<div class="line">                                    lensDistortionCallback::newSyntax);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!status)</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"registerCommand"</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> uninitializePlugin( <a class="code" href="./class_m_object.html">MObject</a> obj)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a>   status;</div>
<div class="line"> <a class="code" href="./class_m_fn_plugin.html">MFnPlugin</a> plugin( obj );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Remove all computation class + callbacks</span></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;MAX_MODEL_PANEL; i++)</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( lensDistortionCompute::currentLensDistortionCompute[i] )</div>
<div class="line">        {</div>
<div class="line"> <span class="keyword">delete</span> lensDistortionCompute::currentLensDistortionCompute[i];</div>
<div class="line">            lensDistortionCompute::currentLensDistortionCompute[i] = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Deregister the command</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    status = plugin.deregisterCommand(<span class="stringliteral">"lensDistortionCallback"</span>);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!status)</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>(<span class="stringliteral">"deregisterCommand"</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="footer-block"><a class="comments-anchor" href="../html/ac.cmtdialog.htm" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div><br/></div>
</link></link></link></link></div></body>
</html>
