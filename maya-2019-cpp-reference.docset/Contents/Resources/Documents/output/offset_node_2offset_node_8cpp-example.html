<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
<head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><script src="../scripts/utils/adsk.redirect.js" type="text/javascript"></script>
<title>offsetNode/offsetNode.cpp</title>
<meta content="C++" name="topic-subtype"/></head>
<body height="100%"><div class="body_content" id="body-content"><link href="cpp_ref/navtree.css" rel="stylesheet" type="text/css"/><link href="cpp_ref/doxygen.css" rel="stylesheet" type="text/css"/><link href="cpp_ref/tabs.css" rel="stylesheet" type="text/css"/><link href="style/adsk.cpm.css" rel="stylesheet" type="text/css"/><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('offset_node_2offset_node_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type="text/javascript">$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->
<div class="Dark" id="MicrosoftTranslatorWidget" style="float:right;z-index:100;color:white;background-color:#bbbbbb;height:58px;overflow:hidden"></div>
<div>
<div class="head">
<h1>offsetNode/offsetNode.cpp</h1>
</div>
<div id="top"><!-- Generated by Doxygen 1.8.10 -->
<div class="tabs" id="navrow1">
<ul class="tablist">
<li><a href="./index.html"><span>MainÂ Page</span></a></li>
<li><a href="./pages.html"><span>Topics</span></a></li>
<li><a href="./modules.html"><span>Modules</span></a></li>
<li><a href="./namespaces.html"><span>Namespaces</span></a></li>
<li><a href="./annotated.html"><span>Classes</span></a></li>
<li><a href="./files.html"><span>Files</span></a></li>
<li><a href="./examples.html"><span>Examples</span></a></li>
</ul>
</div>
</div><!-- top -->
<div class="ui-resizable side-nav-resizable" id="side-nav">
<div id="nav-tree">
<div id="nav-tree-contents">
<div class="sync" id="nav-sync"></div>
</div>
</div>
<div class="ui-resizable-handle" id="splitbar" style="-moz-user-select:none;">
</div>
</div>
<div id="doc-content">
<div class="header">
<div class="headertitle">
<div class="title">offsetNode/offsetNode.cpp</div> </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">//-</span></div>
<div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"><span class="comment">// Copyright 2015 Autodesk, Inc.  All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk</span></div>
<div class="line"><span class="comment">// license agreement provided at the time of installation or download,</span></div>
<div class="line"><span class="comment">// or which otherwise accompanies this software in either electronic</span></div>
<div class="line"><span class="comment">// or hard copy form.</span></div>
<div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"><span class="comment">//+</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"><span class="comment">// DESCRIPTION:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Produces the dependency graph node "offsetNode".</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// This plug-in demonstrates how to create a user-defined weighted deformer</span></div>
<div class="line"><span class="comment">// with an associated shape. A deformer is a node which takes any number of</span></div>
<div class="line"><span class="comment">// input geometries, deforms them, and places the output into the output</span></div>
<div class="line"><span class="comment">// geometry attribute. This example plug-in defines a new deformer node</span></div>
<div class="line"><span class="comment">// that offsets vertices according to their CV's weights. The weights are set</span></div>
<div class="line"><span class="comment">// using the set editor or the percent command.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// To use this node: </span></div>
<div class="line"><span class="comment">//  - create a plane or some other object</span></div>
<div class="line"><span class="comment">//  - type: "deformer -type offset" </span></div>
<div class="line"><span class="comment">//  - a locator is created by the command, and you can use this locator</span></div>
<div class="line"><span class="comment">//    to control the direction of the offset. The object's CV's will be offset</span></div>
<div class="line"><span class="comment">//    by the value of the weights of the CV's (the default will be the weight * some constant)</span></div>
<div class="line"><span class="comment">//    in the direction of the y-vector of the locator </span></div>
<div class="line"><span class="comment">//  - you can edit the weights using either the component editor or by using</span></div>
<div class="line"><span class="comment">//    the percent command (eg. percent -v .5 offset1;) </span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use this script to create a simple example with the offset node:</span></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"><span class="comment">//  loadPlugin offsetNode;</span></div>
<div class="line"><span class="comment">//  polyTorus -r 1 -sr 0.5 -tw 0 -sx 50 -sy 50 -ax 0 1 0 -cuv 1 -ch 1;</span></div>
<div class="line"><span class="comment">//  deformer -type "offset";</span></div>
<div class="line"><span class="comment">//  setKeyframe -v 0 -at rotateZ -t 1 transform1;</span></div>
<div class="line"><span class="comment">//  setKeyframe -v 180 -at rotateZ -t 60 transform1;</span></div>
<div class="line"><span class="comment">//  select -cl;</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MIOStream.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MStringArray.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPxDeformerNode.h&gt;</span> </div>
<div class="line"><span class="preprocessor">#include &lt;maya/MItGeometry.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPxLocatorNode.h&gt;</span> </div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnNumericAttribute.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnMatrixAttribute.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnMatrixData.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnPlugin.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnDependencyNode.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MTypeId.h&gt;</span> </div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPlug.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDataBlock.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDataHandle.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MArrayDataHandle.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPoint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MVector.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MMatrix.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDagModifier.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MPxGPUDeformer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGPUDeformerRegistry.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MOpenCLInfo.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MViewport2Renderer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnMesh.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;clew/clew_cl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>offset : <span class="keyword">public</span> <a name="_a0"></a><a class="code" href="./class_m_px_deformer_node.html">MPxDeformerNode</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">                        offset();</div>
<div class="line">                    ~offset() <span class="keyword">override</span>;</div>
<div class="line"></div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">void</span>*       creator();</div>
<div class="line"> <span class="keyword">static</span> <a name="_a1"></a><a class="code" href="./class_m_status.html">MStatus</a>     initialize();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// deformation function</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> <a name="a2"></a><a class="code" href="./class_m_px_geometry_filter.html#a30d9732c7497ec1c8c7e431eaa5d61b6">deform</a>(<a name="_a3"></a><a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp;      block,</div>
<div class="line"> <a name="_a4"></a><a class="code" href="./class_m_it_geometry.html">MItGeometry</a>&amp;     iter,</div>
<div class="line"> <span class="keyword">const</span> <a name="_a5"></a><a class="code" href="./class_m_matrix.html">MMatrix</a>&amp;   mat,</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     multiIndex) <span class="keyword">override</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// when the accessory is deleted, this node will clean itself up</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a name="_a6"></a><a class="code" href="./class_m_object.html">MObject</a>&amp;            <a name="a7"></a><a class="code" href="./class_m_px_geometry_filter.html#a7abe9ec4327fca72caeea3c8d31299b2">accessoryAttribute</a>() <span class="keyword">const override</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// create accessory nodes when the node is created</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> <a name="a8"></a><a class="code" href="./class_m_px_geometry_filter.html#ab3cfade1b7f20f2d16fb805eb8126995">accessoryNodeSetup</a>(<a name="_a9"></a><a class="code" href="./class_m_dag_modifier.html">MDagModifier</a>&amp; cmd) <span class="keyword">override</span>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> <span class="comment">// local node attributes</span></div>
<div class="line"></div>
<div class="line"> <span class="keyword">static</span> <a class="code" href="./class_m_object.html">MObject</a>     offsetMatrix;   <span class="comment">// offset center and axis</span></div>
<div class="line"> </div>
<div class="line"> <span class="keyword">static</span> <a name="_a10"></a><a class="code" href="./class_m_type_id.html">MTypeId</a>     id;</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_type_id.html">MTypeId</a>     offset::id( 0x8000c );</div>
<div class="line"></div>
<div class="line"><span class="comment">// local attributes</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="./class_m_object.html">MObject</a>     offset::offsetMatrix;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">offset::offset() {}</div>
<div class="line">offset::~offset() {}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span>* offset::creator()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">new</span> offset();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> offset::initialize()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// local attribute initialization</span></div>
<div class="line"></div>
<div class="line"> <a name="_a11"></a><a class="code" href="./class_m_fn_matrix_attribute.html">MFnMatrixAttribute</a>  mAttr;</div>
<div class="line">    offsetMatrix=mAttr.<a name="a12"></a><a class="code" href="./class_m_fn_matrix_attribute.html#acccc043a2ac80be8fe8e32bcc36b8696">create</a>( <span class="stringliteral">"locateMatrix"</span>, <span class="stringliteral">"lm"</span>);</div>
<div class="line">        mAttr.<a name="a13"></a><a class="code" href="./class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>(<span class="keyword">false</span>);</div>
<div class="line">        mAttr.<a name="a14"></a><a class="code" href="./class_m_fn_attribute.html#ab1986dcbce4e2fd86c5cb0bff5119dc0">setConnectable</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line"> <span class="comment">//  deformation attributes</span></div>
<div class="line">    addAttribute( offsetMatrix);</div>
<div class="line"></div>
<div class="line">    attributeAffects( offset::offsetMatrix, offset::outputGeom );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> <a name="a15"></a><a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a></div>
<div class="line">offset::deform( <a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block,</div>
<div class="line"> <a class="code" href="./class_m_it_geometry.html">MItGeometry</a>&amp; iter,</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_matrix.html">MMatrix</a>&amp; <span class="comment">/*m*/</span>,</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> multiIndex)</div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Method: deform</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Description:   Deform the point with a squash algorithm</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Arguments:</span></div>
<div class="line"><span class="comment">//   block      : the datablock of the node</span></div>
<div class="line"><span class="comment">//   iter       : an iterator for the geometry to be deformed</span></div>
<div class="line"><span class="comment">//   m          : matrix to transform the point into world space</span></div>
<div class="line"><span class="comment">//   multiIndex : the index of the geometry that we are deforming</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> returnStatus;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Envelope data from the base class.</span></div>
<div class="line"> <span class="comment">// The envelope is simply a scale factor.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a name="_a16"></a><a class="code" href="./class_m_data_handle.html">MDataHandle</a> envData = block.<a name="a17"></a><a class="code" href="./class_m_data_block.html#af4a356799acd4ed070d372ed7cfb4706">inputValue</a>(envelope, &amp;returnStatus);</div>
<div class="line"> <span class="keywordflow">if</span> (MS::kSuccess != returnStatus) <span class="keywordflow">return</span> returnStatus;</div>
<div class="line"> <span class="keywordtype">float</span> env = envData.<a name="a18"></a><a class="code" href="./class_m_data_handle.html#a43df510424a7de372dd130315d9f223c">asFloat</a>();  </div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get the matrix which is used to define the direction and scale</span></div>
<div class="line"> <span class="comment">// of the offset.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a class="code" href="./class_m_data_handle.html">MDataHandle</a> matData = block.<a class="code" href="./class_m_data_block.html#af4a356799acd4ed070d372ed7cfb4706">inputValue</a>(offsetMatrix, &amp;returnStatus );</div>
<div class="line"> <span class="keywordflow">if</span> (MS::kSuccess != returnStatus) <span class="keywordflow">return</span> returnStatus;</div>
<div class="line"> <a class="code" href="./class_m_matrix.html">MMatrix</a> omat = matData.<a name="a19"></a><a class="code" href="./class_m_data_handle.html#aaa25e9866d30fc06edc510817e32a8f2">asMatrix</a>();</div>
<div class="line"> <a class="code" href="./class_m_matrix.html">MMatrix</a> omatinv = omat.<a name="a20"></a><a class="code" href="./class_m_matrix.html#a8ca5ebc404566e2c4a16d4754772e082">inverse</a>();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// iterate through each point in the geometry</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordflow">for</span> ( ; !iter.<a name="a21"></a><a class="code" href="./class_m_it_geometry.html#a8b6dbf6fbab6f4e7bf50a309124cbf4c">isDone</a>(); iter.<a name="a22"></a><a class="code" href="./class_m_it_geometry.html#a73616f002814b8abe6d921db72d7a496">next</a>()) {</div>
<div class="line"> <a name="_a23"></a><a class="code" href="./class_m_point.html">MPoint</a> pt = iter.<a name="a24"></a><a class="code" href="./class_m_it_geometry.html#a5880c110ed81dd4da0289ccdca5c1592">position</a>();</div>
<div class="line">        pt *= omatinv;</div>
<div class="line"> </div>
<div class="line"> <span class="keywordtype">float</span> weight = weightValue(block,multiIndex,iter.<a name="a25"></a><a class="code" href="./class_m_it_geometry.html#ae85767d1d26fc7491279d1f2c277b499">index</a>());</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// offset algorithm</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">        pt.<a name="a26"></a><a class="code" href="./class_m_point.html#ab927965981178aa1fba979a37168db2a">y</a> = pt.<a class="code" href="./class_m_point.html#ab927965981178aa1fba979a37168db2a">y</a> + env*weight;</div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="comment">// end of offset algorithm</span></div>
<div class="line"></div>
<div class="line">        pt *= omat;</div>
<div class="line">        iter.<a name="a27"></a><a class="code" href="./class_m_it_geometry.html#aab29469f67fee14833472410a17de18f">setPosition</a>(pt);</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> returnStatus;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* override */</span></div>
<div class="line"><a class="code" href="./class_m_object.html">MObject</a>&amp;</div>
<div class="line">offset::accessoryAttribute() const</div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Description:</span></div>
<div class="line"><span class="comment">//    This method returns a the attribute to which an accessory </span></div>
<div class="line"><span class="comment">//    shape is connected. If the accessory shape is deleted, the deformer</span></div>
<div class="line"><span class="comment">//    node will automatically be deleted.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//    This method is optional.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">return</span> offset::offsetMatrix;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* override */</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a></div>
<div class="line">offset::accessoryNodeSetup(<a class="code" href="./class_m_dag_modifier.html">MDagModifier</a>&amp; cmd)</div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Description:</span></div>
<div class="line"><span class="comment">//      This method is called when the deformer is created by the</span></div>
<div class="line"><span class="comment">//      "deformer" command. You can add to the cmds in the MDagModifier</span></div>
<div class="line"><span class="comment">//      cmd in order to hook up any additional nodes that your node needs</span></div>
<div class="line"><span class="comment">//      to operate.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//      In this example, we create a locator and attach its matrix attribute</span></div>
<div class="line"><span class="comment">//      to the matrix input on the offset node. The locator is used to</span></div>
<div class="line"><span class="comment">//      set the direction and scale of the random field.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Description:</span></div>
<div class="line"><span class="comment">//      This method is optional.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> result;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// hook up the accessory node</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a class="code" href="./class_m_object.html">MObject</a> objLoc = cmd.<a name="a28"></a><a class="code" href="./class_m_dag_modifier.html#ae169eb7f1ddc00f53ba69ac2d1815950">createNode</a>(<a name="_a29"></a><a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"locator"</span>),</div>
<div class="line"> <a name="a30"></a><a class="code" href="./class_m_object.html#af2a707b4254eb54763167aeced863e63">MObject::kNullObj</a>,</div>
<div class="line">                                    &amp;result);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (MS::kSuccess == result) {</div>
<div class="line"> <a name="_a31"></a><a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> fnLoc(objLoc);</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> attrName;</div>
<div class="line">        attrName.<a name="a32"></a><a class="code" href="./class_m_string.html#acee761fe098fc30a5ac1437e3aca5bc0">set</a>(<span class="stringliteral">"matrix"</span>);</div>
<div class="line"> <a class="code" href="./class_m_object.html">MObject</a> attrMat = fnLoc.attribute(attrName);</div>
<div class="line"></div>
<div class="line">        result = cmd.<a name="a33"></a><a class="code" href="./class_m_d_g_modifier.html#afbd18f066f70fcd1864ddb4af91f3c7b">connect</a>(objLoc,attrMat,this-&gt;thisMObject(),offset::offsetMatrix);</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// the GPU override implementation of the offsetNode</span></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>offsetGPUDeformer : <span class="keyword">public</span> <a name="_a34"></a><a class="code" href="./class_m_px_g_p_u_deformer.html">MPxGPUDeformer</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> <span class="comment">// Virtual methods from MPxGPUDeformer</span></div>
<div class="line">    offsetGPUDeformer();</div>
<div class="line">    ~offsetGPUDeformer() <span class="keyword">override</span>;</div>
<div class="line"></div>
<div class="line">    MPxGPUDeformer::DeformerStatus <a name="a35"></a><a class="code" href="./class_m_px_g_p_u_deformer.html#a070259639bc552fd702c9e8e042f0331">evaluate</a>(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a name="_a36"></a><a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a name="_a37"></a><a class="code" href="./class_m_plug.html">MPlug</a>&amp; outputPlug, <span class="keyword">const</span> <a name="_a38"></a><a class="code" href="./class_m_g_p_u_deformer_data.html">MGPUDeformerData</a>&amp; inputData, <a class="code" href="./class_m_g_p_u_deformer_data.html">MGPUDeformerData</a>&amp; outputData) <span class="keyword">override</span>;</div>
<div class="line"> <span class="keywordtype">void</span> <a name="a39"></a><a class="code" href="./class_m_px_g_p_u_deformer.html#a74a45d2648335936561898c390281a6a">terminate</a>() <span class="keyword">override</span>;</div>
<div class="line"></div>
<div class="line"> <span class="keyword">static</span> <a name="_a40"></a><a class="code" href="./class_m_g_p_u_deformer_registration_info.html">MGPUDeformerRegistrationInfo</a>* getGPUDeformerInfo();</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">bool</span> validateNodeInGraph(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp;, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug, <a name="_a41"></a><a class="code" href="./class_m_string_array.html">MStringArray</a>* messages);</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">bool</span> validateNodeValues(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp;, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug, <a class="code" href="./class_m_string_array.html">MStringArray</a>* messages);</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"> <span class="comment">// helper methods</span></div>
<div class="line"> <span class="keywordtype">void</span> extractWeightArray(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug);</div>
<div class="line"> <span class="keywordtype">void</span> extractOffsetMatrix(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Storage for data on the GPU</span></div>
<div class="line"> <a name="_a42"></a><a class="code" href="./class_m_auto_c_l_mem.html">MAutoCLMem</a> fCLWeights;</div>
<div class="line"> <a class="code" href="./class_m_auto_c_l_mem.html">MAutoCLMem</a> fOffsetMatrix;</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fNumElements;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Kernel</span></div>
<div class="line"> <a name="_a43"></a><a class="code" href="./class_m_auto_c_l_kernel.html">MAutoCLKernel</a> fKernel;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>offsetNodeGPUDeformerInfo : <span class="keyword">public</span> <a class="code" href="./class_m_g_p_u_deformer_registration_info.html">MGPUDeformerRegistrationInfo</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    offsetNodeGPUDeformerInfo() {}</div>
<div class="line">    ~offsetNodeGPUDeformerInfo()<span class="keyword"> override</span>{}</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_px_g_p_u_deformer.html">MPxGPUDeformer</a>* <a name="a44"></a><a class="code" href="./class_m_g_p_u_deformer_registration_info.html#a69ee4850048ea760d9e03f2deaf957e4">createGPUDeformer</a>()<span class="keyword"> override</span></div>
<div class="line"><span class="keyword"> </span>{</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">new</span> offsetGPUDeformer();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> <span class="keywordtype">bool</span> <a name="a45"></a><a class="code" href="./class_m_g_p_u_deformer_registration_info.html#af612f89c960cf432dc7be0d3f1be8d93">validateNodeInGraph</a>(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug, <a class="code" href="./class_m_string_array.html">MStringArray</a>* messages)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword"> </span>{</div>
<div class="line"> <span class="keywordflow">return</span> offsetGPUDeformer::validateNodeInGraph(block, evaluationNode, plug, messages);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">bool</span> <a name="a46"></a><a class="code" href="./class_m_g_p_u_deformer_registration_info.html#a5211d6842c7677f9730a9c76cb258568">validateNodeValues</a>(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug, <a class="code" href="./class_m_string_array.html">MStringArray</a>* messages)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword"> </span>{</div>
<div class="line"> <span class="keywordflow">return</span> offsetGPUDeformer::validateNodeValues(block, evaluationNode, plug, messages);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_g_p_u_deformer_registration_info.html">MGPUDeformerRegistrationInfo</a>* offsetGPUDeformer::getGPUDeformerInfo()</div>
<div class="line">{</div>
<div class="line"> <span class="keyword">static</span> offsetNodeGPUDeformerInfo theOne;</div>
<div class="line"> <span class="keywordflow">return</span> &amp;theOne;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">offsetGPUDeformer::offsetGPUDeformer()</div>
<div class="line">    : fNumElements(0)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Remember the ctor must be fast.  No heavy work should be done here.</span></div>
<div class="line"> <span class="comment">// Maya may allocate one of these and then never use it.</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">offsetGPUDeformer::~offsetGPUDeformer()</div>
<div class="line">{</div>
<div class="line">    terminate();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* static */</span></div>
<div class="line"><span class="keywordtype">bool</span> offsetGPUDeformer::validateNodeInGraph(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug, <a class="code" href="./class_m_string_array.html">MStringArray</a>* messages)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// offsetGPUDeformer supports everything on the offset node except envelope</span></div>
<div class="line"> <span class="comment">// envelope is handled in validateNodeValues because we support some values</span></div>
<div class="line"> <span class="comment">// but not others.</span></div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* static */</span></div>
<div class="line"><span class="keywordtype">bool</span> offsetGPUDeformer::validateNodeValues(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug, <a class="code" href="./class_m_string_array.html">MStringArray</a>* messages)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// As an example offsetGPUDeformer has conditional support for the envelop</span></div>
<div class="line"> <span class="comment">// attribute.  offsetGPUDeformer supports the underlying depend node if</span></div>
<div class="line"> <span class="comment">// envelope is exactly 1.0f.  Otherwise, the underlying node is not supported.</span></div>
<div class="line"> <span class="comment">// Note that in additional to testing the value of the envelope attribute here</span></div>
<div class="line"> <span class="comment">// we have also registered the envelope attribute as a conditional attribute in</span></div>
<div class="line"> <span class="comment">// offsetNodeGPUDeformerInfo.</span></div>
<div class="line"> </div>
<div class="line"> <a class="code" href="./class_m_object.html">MObject</a> node = plug.<a name="a47"></a><a class="code" href="./class_m_plug.html#ae024049dad815f2f186e6a4fead8be51">node</a>();</div>
<div class="line"> <a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> fnNode(node);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now that I know the envelope value is not changing, check to see if it is 1.0f</span></div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> envelopePlug(node, <a name="a48"></a><a class="code" href="./class_m_px_geometry_filter.html#a7ec5f07562204a9fa9b136a856cb97c4">MPxDeformerNode::envelope</a>);</div>
<div class="line"> <a class="code" href="./class_m_data_handle.html">MDataHandle</a> envData;</div>
<div class="line">    envelopePlug.getValue(envData);</div>
<div class="line"> <span class="keywordflow">if</span> (envData.<a class="code" href="./class_m_data_handle.html#a43df510424a7de372dd130315d9f223c">asFloat</a>() != 1.0f)</div>
<div class="line">    {</div>
<div class="line"> <a name="a49"></a><a class="code" href="./class_m_open_c_l_info.html#a8682346bb79641242ffc37e0b163f136">MOpenCLInfo::appendMessage</a>(messages, <span class="stringliteral">"Offset %s not supported by deformer evaluator because envelope is not exactly 1.0."</span>, fnNode.name().asChar());</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">MPxGPUDeformer::DeformerStatus offsetGPUDeformer::evaluate( </div>
<div class="line"> <a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block,                          <span class="comment">// data block for "this" node</span></div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode,      <span class="comment">// evaluation node representing "this" node</span></div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug,                          <span class="comment">// the multi index we're working on.  There will be a separate instance created per multi index</span></div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_g_p_u_deformer_data.html">MGPUDeformerData</a>&amp; inputData,          <span class="comment">// the input data provided by Maya or other upstream GPU Deformers</span></div>
<div class="line"> <a class="code" href="./class_m_g_p_u_deformer_data.html">MGPUDeformerData</a>&amp; outputData                <span class="comment">// the output data to be passed to the rendering system or other downstream GPU Deformers</span></div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line"> <span class="keyword">const</span> <a name="_a50"></a><a class="code" href="./class_m_g_p_u_deformer_buffer.html">MGPUDeformerBuffer</a> inputPositions = inputData.<a name="a51"></a><a class="code" href="./class_m_g_p_u_deformer_data.html#a5ce2553c6e11160092fa5f97721f0262">getBuffer</a>(MPxGPUDeformer::sPositionsName());</div>
<div class="line"> <a class="code" href="./class_m_g_p_u_deformer_buffer.html">MGPUDeformerBuffer</a> outputPositions = createOutputBuffer(inputPositions);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!inputPositions.<a name="a52"></a><a class="code" href="./class_m_g_p_u_deformer_buffer.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>() || !outputPositions.<a class="code" href="./class_m_g_p_u_deformer_buffer.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>()) <span class="keywordflow">return</span> MPxGPUDeformer::kDeformerFailure;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// evaluate has two main pieces of work.  I need to transfer any data I care about onto the GPU, and I need to run my OpenCL Kernel.</span></div>
<div class="line"> <span class="comment">// First, transfer the data.  offset has two pieces of data I need to transfer to the GPU, the weight array and the offset matrix.</span></div>
<div class="line"> <span class="comment">// I don't need to transfer down the input position buffer, that is already handled by the deformer evaluator, the points are in inputBuffer.</span></div>
<div class="line">    fNumElements = inputPositions.<a name="a53"></a>elementCount();</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_object.html">MObject</a> node = plug.<a class="code" href="./class_m_plug.html#ae024049dad815f2f186e6a4fead8be51">node</a>();</div>
<div class="line"></div>
<div class="line">    extractWeightArray(block, evaluationNode, plug);</div>
<div class="line">    extractOffsetMatrix(block, evaluationNode, plug);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now that all the data we care about is on the GPU, setup and run the OpenCL Kernel</span></div>
<div class="line"> <span class="keywordflow">if</span> (!fKernel.get())</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordtype">char</span> *maya_location = getenv( <span class="stringliteral">"MAYA_LOCATION"</span> );</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> openCLKernelFile(maya_location);</div>
<div class="line">        openCLKernelFile +=<span class="stringliteral">"/../Extra/devkitBase/devkit/plug-ins/offsetNode/offset.cl"</span>;</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> openCLKernelName(<span class="stringliteral">"offset"</span>);</div>
<div class="line">        fKernel = <a name="a54"></a><a class="code" href="./class_m_open_c_l_info.html#a9b9a0680620c0ecac7dd1b07159ee72f">MOpenCLInfo::getOpenCLKernel</a>(openCLKernelFile, openCLKernelName);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!fKernel) <span class="keywordflow">return</span> MPxGPUDeformer::kDeformerFailure;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    cl_int err = CL_SUCCESS;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Set all of our kernel parameters.  Input buffer and output buffer may be changing every frame</span></div>
<div class="line"> <span class="comment">// so always set them.</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> parameterId = 0;</div>
<div class="line">    err = clSetKernelArg(fKernel.get(), parameterId++, <span class="keyword">sizeof</span>(cl_mem), (<span class="keywordtype">void</span>*)outputPositions.buffer().getReadOnlyRef());</div>
<div class="line"> <a name="_a55"></a><a class="code" href="./class_m_open_c_l_info.html">MOpenCLInfo</a>::checkCLErrorStatus(err);</div>
<div class="line">    err = clSetKernelArg(fKernel.get(), parameterId++, sizeof(cl_mem), (<span class="keywordtype">void</span>*)inputPositions.buffer().getReadOnlyRef());</div>
<div class="line"> <a class="code" href="./class_m_open_c_l_info.html">MOpenCLInfo</a>::checkCLErrorStatus(err);</div>
<div class="line">    err = clSetKernelArg(fKernel.get(), parameterId++, sizeof(cl_mem), (<span class="keywordtype">void</span>*)fCLWeights.getReadOnlyRef());</div>
<div class="line"> <a class="code" href="./class_m_open_c_l_info.html">MOpenCLInfo</a>::checkCLErrorStatus(err);</div>
<div class="line">    err = clSetKernelArg(fKernel.get(), parameterId++, sizeof(cl_mem), (<span class="keywordtype">void</span>*)fOffsetMatrix.getReadOnlyRef());</div>
<div class="line"> <a class="code" href="./class_m_open_c_l_info.html">MOpenCLInfo</a>::checkCLErrorStatus(err);</div>
<div class="line">    err = clSetKernelArg(fKernel.get(), parameterId++, sizeof(cl_uint), (<span class="keywordtype">void</span>*)&amp;fNumElements);</div>
<div class="line"> <a class="code" href="./class_m_open_c_l_info.html">MOpenCLInfo</a>::checkCLErrorStatus(err);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Figure out a good work group size for our kernel.</span></div>
<div class="line"> <span class="keywordtype">size_t</span> workGroupSize;</div>
<div class="line"> <span class="keywordtype">size_t</span> retSize;</div>
<div class="line">    err = clGetKernelWorkGroupInfo(</div>
<div class="line">        fKernel.get(),</div>
<div class="line"> <a class="code" href="./class_m_open_c_l_info.html">MOpenCLInfo</a>::getOpenCLDeviceId(),</div>
<div class="line">        CL_KERNEL_WORK_GROUP_SIZE,</div>
<div class="line">        sizeof(<span class="keywordtype">size_t</span>),</div>
<div class="line">        &amp;workGroupSize,</div>
<div class="line">        &amp;retSize);</div>
<div class="line"> <a class="code" href="./class_m_open_c_l_info.html">MOpenCLInfo</a>::checkCLErrorStatus(err);</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">size_t</span> localWorkSize = 256;</div>
<div class="line">    if (retSize &gt; 0) localWorkSize = workGroupSize;</div>
<div class="line"> <span class="keywordtype">size_t</span> globalWorkSize = (localWorkSize - fNumElements % localWorkSize) + fNumElements; <span class="comment">// global work size must be a multiple of localWorkSize</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// set up our input events.  The input event could be NULL, in that case we need to pass</span></div>
<div class="line"> <span class="comment">// slightly different parameters into clEnqueueNDRangeKernel</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numInputEvents = 0;</div>
<div class="line">    if (inputPositions.bufferReadyEvent().get())</div>
<div class="line">    {</div>
<div class="line">        numInputEvents = 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// run the kernel</span></div>
<div class="line"> <a name="_a56"></a><a class="code" href="./class_m_auto_c_l_event.html">MAutoCLEvent</a> kernelFinishedEvent;</div>
<div class="line">    err = clEnqueueNDRangeKernel(</div>
<div class="line"> <a name="a57"></a><a class="code" href="./class_m_open_c_l_info.html#a93e129c1488b06f3347eaaad703ffe34">MOpenCLInfo::getMayaDefaultOpenCLCommandQueue</a>(),</div>
<div class="line">        fKernel.get(),</div>
<div class="line">        1,</div>
<div class="line">        NULL,</div>
<div class="line">        &amp;globalWorkSize,</div>
<div class="line">        &amp;localWorkSize,</div>
<div class="line">        numInputEvents,</div>
<div class="line">        numInputEvents ? inputPositions.<a name="a58"></a>bufferReadyEvent().<a name="a59"></a><a class="code" href="./class_m_auto_c_l_event.html#a54368f5ece5ae240f0b56da10231d77d">getReadOnlyRef</a>() : 0,</div>
<div class="line">        kernelFinishedEvent.<a name="a60"></a><a class="code" href="./class_m_auto_c_l_event.html#a5622645d1b16ac4ab77c233dcea5c5be">getReferenceForAssignment</a>());</div>
<div class="line">    outputPositions.<a name="a61"></a>setBufferReadyEvent(kernelFinishedEvent);</div>
<div class="line"> <a name="a62"></a><a class="code" href="./class_m_open_c_l_info.html#a753d7277906776cd710b3723d74f8b64">MOpenCLInfo::checkCLErrorStatus</a>(err);</div>
<div class="line"></div>
<div class="line">    outputData.<a name="a63"></a><a class="code" href="./class_m_g_p_u_deformer_data.html#a9710db42ff7918d4b588b0045fecdcd0">setBuffer</a>(outputPositions);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> MPxGPUDeformer::kDeformerSuccess;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> offsetGPUDeformer::terminate()</div>
<div class="line">{</div>
<div class="line"> <a name="a64"></a><a class="code" href="./class_m_h_w_render_1_1_m_renderer.html#a4678a72ac6959ed21d422d27928d0343">MHWRender::MRenderer::theRenderer</a>()-&gt;<a name="a65"></a><a class="code" href="./class_m_h_w_render_1_1_m_renderer.html#a539094d46be4675c5690419f1c09b38e">releaseGPUMemory</a>(fNumElements*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line">    fCLWeights.reset();</div>
<div class="line">    fOffsetMatrix.reset();</div>
<div class="line"> <a name="a66"></a><a class="code" href="./class_m_open_c_l_info.html#a08df219d94dcf2dc03724eff7d5c6483">MOpenCLInfo::releaseOpenCLKernel</a>(fKernel);</div>
<div class="line">    fKernel.reset();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> offsetGPUDeformer::extractWeightArray(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// if we've already got a weight array and it is not changing then don't bother copying it</span></div>
<div class="line"> <span class="comment">// to the GPU again</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Note that right now hasAttributeBeenModified takes an attribute, so if any element in the multi is changing we think it is dirty...</span></div>
<div class="line"> <span class="comment">// To avoid false dirty issues here you'd need to only use one element of the MPxDeformerNode::input multi attribute for each</span></div>
<div class="line"> <span class="comment">// offset node.</span></div>
<div class="line"> <span class="keywordflow">if</span> (fCLWeights.get() &amp;&amp; !<a name="a67"></a><a class="code" href="./class_m_px_g_p_u_deformer.html#abb7238dc52214c1b33a9c4000c1f237e">MPxGPUDeformer::hasAttributeBeenModified</a>(evaluationNode, <a name="a68"></a><a class="code" href="./class_m_px_deformer_node.html#a35a26e066faae03152b67f2067b1d53f">MPxDeformerNode::weightList</a>))</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Maya might do some tricky stuff like not store the weight array at all for certain weight</span></div>
<div class="line"> <span class="comment">// values so we can't count on an array existing in the weightList.  For the OpenCL Kernel</span></div>
<div class="line"> <span class="comment">// we want an array with one weight in it per vertex, we need to build it carefully here.</span></div>
<div class="line">    std::vector&lt;float&gt; temp;</div>
<div class="line">    temp.reserve(fNumElements);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Two possibilities: we could have a sparse array in weightList[multiIndex] or there could be nothing in weightList[multiIndex].</span></div>
<div class="line"> <span class="comment">// if nothing is there then all the weights at 1.0f.</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get a handle to the weight array we want.</span></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"> <a name="_a69"></a><a class="code" href="./class_m_array_data_handle.html">MArrayDataHandle</a> weightList = block.<a name="a70"></a><a class="code" href="./class_m_data_block.html#a11fd41c7d97d656a2bffdc23015f1496">outputArrayValue</a>(<a class="code" href="./class_m_px_deformer_node.html#a35a26e066faae03152b67f2067b1d53f">MPxDeformerNode::weightList</a>, &amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (!status) <span class="keywordflow">return</span>; <span class="comment">// we should always be able to get a weightList</span></div>
<div class="line">    status = weightList.<a name="a71"></a><a class="code" href="./class_m_array_data_handle.html#a8d77f0fea87bb6854b60cd199bf26240">jumpToElement</a>(plug.<a name="a72"></a><a class="code" href="./class_m_plug.html#aee365de27bc5ea401941e79738cc4afe">logicalIndex</a>());</div>
<div class="line"> <span class="comment">// it is possible that the jumpToElement fails.  In that case all weights are 1.</span></div>
<div class="line"> <span class="keywordflow">if</span> (!status)</div>
<div class="line">    {   </div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;fNumElements; i++)</div>
<div class="line">            temp.push_back(1.0f);</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_data_handle.html">MDataHandle</a> weightsStructure = weightList.<a name="a73"></a><a class="code" href="./class_m_array_data_handle.html#a81d24dca6d647d8d0a8fe0ef2c63b170">inputValue</a>(&amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (!status) <span class="keywordflow">return</span>;</div>
<div class="line"> <a class="code" href="./class_m_array_data_handle.html">MArrayDataHandle</a> weights = weightsStructure.<a name="a74"></a><a class="code" href="./class_m_data_handle.html#a58951af761a410e17982060cae4fdf49">child</a>(<a name="a75"></a><a class="code" href="./class_m_px_deformer_node.html#ae4200be6c5a30e8d817e6a3b51d20402">MPxDeformerNode::weights</a>);</div>
<div class="line"> <span class="keywordflow">if</span> (!status) <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// number of non-zero weights</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numWeights = weights.<a name="a76"></a><a class="code" href="./class_m_array_data_handle.html#a5f3dd1d27853eccbbe78b6d4383ccb79">elementCount</a>(&amp;status);</div>
<div class="line"> <span class="keywordflow">if</span> (!status) <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// we're building a list with a weight per vertex, even if the weight is zero</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> weightIndex = 0;</div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;numWeights; i++, weights.<a name="a77"></a><a class="code" href="./class_m_array_data_handle.html#a73616f002814b8abe6d921db72d7a496">next</a>())</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> weightsElementIndex = weights.<a name="a78"></a><a class="code" href="./class_m_array_data_handle.html#a2ca3c3d60cf2f3ac005b651379f26143">elementIndex</a>(&amp;status);</div>
<div class="line"> <span class="keywordflow">while</span> (weightIndex &lt; weightsElementIndex)</div>
<div class="line">            {</div>
<div class="line">                temp.push_back(1.0f); <span class="comment">// weights could be sparse, fill in default weight of 1 if no data</span></div>
<div class="line">                weightIndex++;</div>
<div class="line">            }</div>
<div class="line"> <a class="code" href="./class_m_data_handle.html">MDataHandle</a> value = weights.<a class="code" href="./class_m_array_data_handle.html#a81d24dca6d647d8d0a8fe0ef2c63b170">inputValue</a>(&amp;status);</div>
<div class="line">            temp.push_back(value.<a class="code" href="./class_m_data_handle.html#a43df510424a7de372dd130315d9f223c">asFloat</a>());</div>
<div class="line">            weightIndex++;</div>
<div class="line">        }</div>
<div class="line"> <span class="comment">// now we have written the last non-zero weight into temp, but the last non-zero weight</span></div>
<div class="line"> <span class="comment">// doesn't have to be for the last vertex in the buffer.  Add more zero values if necessary.</span></div>
<div class="line"> <span class="keywordflow">while</span> (weightIndex &lt; fNumElements)</div>
<div class="line">        {</div>
<div class="line">            temp.push_back(1.0f); <span class="comment">// weights could be sparse, fill in default weight of 1 if no data</span></div>
<div class="line">            weightIndex++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Two possibilities, we could be updating an existing OpenCL buffer or allocating a new one.</span></div>
<div class="line">    cl_int err = CL_SUCCESS;</div>
<div class="line"> <span class="keywordflow">if</span> (!fCLWeights.get())</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_h_w_render_1_1_m_renderer.html#a4678a72ac6959ed21d422d27928d0343">MHWRender::MRenderer::theRenderer</a>()-&gt;<a name="a79"></a><a class="code" href="./class_m_h_w_render_1_1_m_renderer.html#ab4c1def24e934781098b800fd8b16cdd">holdGPUMemory</a>(fNumElements*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line">        fCLWeights.attach(clCreateBuffer(<a name="a80"></a><a class="code" href="./class_m_open_c_l_info.html#a2ab4ea6f879cbd19b67ca57cb3474d7b">MOpenCLInfo::getOpenCLContext</a>(), CL_MEM_COPY_HOST_PTR | CL_MEM_READ_ONLY, fNumElements * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), (<span class="keywordtype">void</span>*)&amp;temp[0], &amp;err));</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// I use a blocking write here, non-blocking could be faster...  need to manage the lifetime of temp, and have the kernel wait until the write finishes before running</span></div>
<div class="line"> <span class="comment">// I'm also assuming that the weight buffer is not growing.</span></div>
<div class="line">        err = clEnqueueWriteBuffer(<a class="code" href="./class_m_open_c_l_info.html#a93e129c1488b06f3347eaaad703ffe34">MOpenCLInfo::getMayaDefaultOpenCLCommandQueue</a>(), fCLWeights.get(), CL_TRUE, 0, fNumElements * <span class="keyword">sizeof</span>(float), (<span class="keywordtype">void</span>*)&amp;temp[0], 0, NULL, NULL);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> offsetGPUDeformer::extractOffsetMatrix(<a class="code" href="./class_m_data_block.html">MDataBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="./class_m_evaluation_node.html">MEvaluationNode</a>&amp; evaluationNode, <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// I pass the offset matrix to OpenCL using a buffer as well.  I also send down the inverse matrix to avoid calculating it many times on the GPU</span></div>
<div class="line"> <span class="keywordflow">if</span> (fOffsetMatrix.get() &amp;&amp; !<a class="code" href="./class_m_px_g_p_u_deformer.html#abb7238dc52214c1b33a9c4000c1f237e">MPxGPUDeformer::hasAttributeBeenModified</a>(evaluationNode, offset::offsetMatrix))</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"> <a class="code" href="./class_m_data_handle.html">MDataHandle</a> matData = block.<a class="code" href="./class_m_data_block.html#af4a356799acd4ed070d372ed7cfb4706">inputValue</a>(offset::offsetMatrix, &amp;status );</div>
<div class="line"> <span class="keywordflow">if</span> (MS::kSuccess != status) <span class="keywordflow">return</span>;</div>
<div class="line"> <a class="code" href="./class_m_matrix.html">MMatrix</a> omat = matData.<a class="code" href="./class_m_data_handle.html#aaa25e9866d30fc06edc510817e32a8f2">asMatrix</a>();</div>
<div class="line"> <a class="code" href="./class_m_matrix.html">MMatrix</a> omatinv = omat.<a class="code" href="./class_m_matrix.html#a8ca5ebc404566e2c4a16d4754772e082">inverse</a>();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Convert the matrix from Maya format to the format the OpenCL kernel expects</span></div>
<div class="line">    omat = omat.<a name="a81"></a><a class="code" href="./class_m_matrix.html#a6fadbac6023eb9d361176a87b73063dc">transpose</a>();</div>
<div class="line">    omatinv = omatinv.<a class="code" href="./class_m_matrix.html#a6fadbac6023eb9d361176a87b73063dc">transpose</a>();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// MMatrix stores double values, but I want floating point values on the GPU so convert them here.</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numFloat = 32;</div>
<div class="line"> <span class="keywordtype">float</span>* temp = <span class="keyword">new</span> <span class="keywordtype">float</span>[numFloat];</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> curr = 0;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> row = 0; row&lt;4; row++)</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> column = 0; column&lt;4; column++)</div>
<div class="line">        {</div>
<div class="line">            temp[curr++] = (float)omat(row, column);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> row = 0; row&lt;4; row++)</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> column = 0; column&lt;4; column++)</div>
<div class="line">        {</div>
<div class="line">            temp[curr++] = (float)omatinv(row, column);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Two possibilities, we could be updating an existing OpenCL buffer or allocating a new one.</span></div>
<div class="line">    cl_int err = CL_SUCCESS;</div>
<div class="line"> <span class="keywordflow">if</span> (!fOffsetMatrix.get())</div>
<div class="line">    {</div>
<div class="line">        fOffsetMatrix.attach(clCreateBuffer(<a class="code" href="./class_m_open_c_l_info.html#a2ab4ea6f879cbd19b67ca57cb3474d7b">MOpenCLInfo::getOpenCLContext</a>(), CL_MEM_COPY_HOST_PTR | CL_MEM_READ_ONLY, numFloat * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), (<span class="keywordtype">void</span>*) temp, &amp;err));</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// I use a blocking write here, non-blocking could be faster...  need to manage the lifetime of temp, and have the kernel wait until the write finishes before running</span></div>
<div class="line">        err = clEnqueueWriteBuffer(<a class="code" href="./class_m_open_c_l_info.html#a93e129c1488b06f3347eaaad703ffe34">MOpenCLInfo::getMayaDefaultOpenCLCommandQueue</a>(), fOffsetMatrix.get(), CL_TRUE, 0, numFloat * <span class="keyword">sizeof</span>(float), (<span class="keywordtype">void</span>*)temp, 0, NULL, NULL);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    delete [] temp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// standard initialization procedures</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> initializePlugin( <a class="code" href="./class_m_object.html">MObject</a> obj )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> result;</div>
<div class="line"> <a name="_a82"></a><a class="code" href="./class_m_fn_plugin.html">MFnPlugin</a> plugin( obj, PLUGIN_COMPANY, <span class="stringliteral">"3.0"</span>, <span class="stringliteral">"Any"</span>);</div>
<div class="line">    result = plugin.registerNode( <span class="stringliteral">"offset"</span>, offset::id, offset::creator, </div>
<div class="line">                                  offset::initialize, <a name="a83"></a><a class="code" href="./class_m_px_node.html#a1d1cfd8ffb84e947f82999c682b666a7a397b2fe312ffa55c207f8f9b12f616d3">MPxNode::kDeformerNode</a> );</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> nodeClassName(<span class="stringliteral">"offset"</span>);</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> registrantId(<span class="stringliteral">"mayaPluginExample"</span>);</div>
<div class="line"> <a name="a84"></a><a class="code" href="./class_m_g_p_u_deformer_registry.html#adea377dddd00bec03a6cdf70360f567f">MGPUDeformerRegistry::registerGPUDeformerCreator</a>(</div>
<div class="line">        nodeClassName,</div>
<div class="line">        registrantId,</div>
<div class="line">        offsetGPUDeformer::getGPUDeformerInfo());</div>
<div class="line"></div>
<div class="line"> <a name="a85"></a><a class="code" href="./class_m_g_p_u_deformer_registry.html#a2e96bdde07077e4af65457c6edb9c11a">MGPUDeformerRegistry::addConditionalAttribute</a>(</div>
<div class="line">            nodeClassName,</div>
<div class="line">            registrantId,</div>
<div class="line"> <a class="code" href="./class_m_px_geometry_filter.html#a7ec5f07562204a9fa9b136a856cb97c4">MPxDeformerNode::envelope</a>);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> uninitializePlugin( <a class="code" href="./class_m_object.html">MObject</a> obj)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> result;</div>
<div class="line"> <a class="code" href="./class_m_fn_plugin.html">MFnPlugin</a> plugin( obj );</div>
<div class="line">    result = plugin.deregisterNode( offset::id );</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> nodeClassName(<span class="stringliteral">"offset"</span>);</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> registrantId(<span class="stringliteral">"mayaPluginExample"</span>);</div>
<div class="line"> <a name="a86"></a><a class="code" href="./class_m_g_p_u_deformer_registry.html#aa290ea8dc9cb67e1056f132b8e441d5f">MGPUDeformerRegistry::deregisterGPUDeformerCreator</a>(</div>
<div class="line">        nodeClassName,</div>
<div class="line">        registrantId);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="footer-block"><a class="comments-anchor" href="../html/ac.cmtdialog.htm" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
</div></body>
</html>
